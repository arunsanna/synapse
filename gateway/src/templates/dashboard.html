<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>synapse :: terminal</title>
    <style>
        /* Terminal CLI — monospace everything */

        :root {
            /* --- Phosphor Monitor Palette --- */
            --bg-primary: #0a0a0a;
            --bg-surface: #0d0d0d;
            --bg-surface-hover: #141414;
            --bg-input: #080808;
            --bg-elevated: #111111;

            /* Borders — green tint */
            --border-color: #1a3a1a;
            --border-color-subtle: #0f1f0f;
            --border-color-strong: #2a5a2a;

            /* Text — phosphor green hierarchy (WCAG AA compliant) */
            --text-primary: #4af626;
            --text-secondary: #3ddb3d;
            --text-tertiary: #2e9a2e;

            /* Accent — amber */
            --accent: #ff6600;

            /* Status LEDs */
            --led-green: #4af626;
            --led-amber: #ffaa00;
            --led-red: #ff3333;
            --led-grey: #333333;
            --led-blue: #00aaff;

            /* Shadows — glow only */
            --shadow-elevated: 0 0 20px rgba(74, 246, 38, 0.1);

            /* Radii — subtle rounding for interactive element affordance */
            --radius-panel: 3px;
            --radius-btn: 3px;
            --radius-pill: 3px;

            /* Legacy aliases */
            --neu-base: var(--bg-surface);
            --neu-dark: var(--border-color);
            --neu-light: var(--bg-surface-hover);
            --orange: var(--accent);
            --shadow-card: none;
            --shadow-float: none;
            --shadow-pressed: none;
            --shadow-recessed: none;

            /* --- Terminal glow tokens --- */
            --glow-text: 0 0 6px rgba(74, 246, 38, 0.25);
            --glow-text-bright: 0 0 8px rgba(74, 246, 38, 0.35);
            --glow-border: 0 0 3px rgba(74, 246, 38, 0.1);

            /* --- Hard-surface tokens (formerly hard-coded) --- */
            --bg-terminal: #050505;
            --bg-sidebar: #080808;
            --bg-overlay: rgba(0, 0, 0, 0.92);
            --bg-backdrop: rgba(0, 0, 0, 0.5);
            --scanline-color: rgba(0, 0, 0, 0.025);
            --iframe-filter: invert(0.88) hue-rotate(180deg);
        }

        /* --- Light Theme --- */
        [data-theme="light"] {
            --bg-primary: #f0f0ed;
            --bg-surface: #ffffff;
            --bg-surface-hover: #e8e8e4;
            --bg-input: #f6f6f3;
            --bg-elevated: #ffffff;

            --border-color: #c0d0c0;
            --border-color-subtle: #d8e4d8;
            --border-color-strong: #8ab88a;

            --text-primary: #1a5c1a;
            --text-secondary: #2a7a2a;
            --text-tertiary: #6a9a6a;

            --accent: #d45500;

            --led-green: #22a822;
            --led-amber: #cc8800;
            --led-red: #cc2222;
            --led-grey: #aaaaaa;
            --led-blue: #0088cc;

            --shadow-elevated: 0 2px 12px rgba(0, 0, 0, 0.08);

            --glow-text: none;
            --glow-text-bright: none;
            --glow-border: 0 0 0 1px rgba(26, 92, 26, 0.08);

            --bg-terminal: #f8f8f5;
            --bg-sidebar: #f4f4f0;
            --bg-overlay: rgba(255, 255, 255, 0.92);
            --bg-backdrop: rgba(0, 0, 0, 0.2);
            --scanline-color: transparent;
            --iframe-filter: none;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { min-height: 100%; }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', monospace;
            line-height: 1.5;
            letter-spacing: -0.01em;
            padding: 0;
            position: relative;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body::before {
            content: '';
            display: block;
            position: fixed;
            inset: 0;
            z-index: 9999;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                var(--scanline-color) 2px,
                var(--scanline-color) 4px
            );
        }

        a { color: var(--text-secondary); text-decoration: none; transition: color 0.15s ease; }
        a:hover { color: var(--text-primary); }
        code, .mono { font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', monospace; }

        .page {
            max-width: none;
            width: 100%;
            margin: 0;
            display: grid;
            gap: 0.75rem;
            position: relative;
            z-index: 1;
        }

        /* --- Panels --- */
        .neu-panel {
            background: var(--bg-surface);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            padding: 0;
            position: relative;
            overflow: hidden;
            transition: border-color 0.15s ease;
        }
        .neu-panel:hover { border-color: var(--border-color-strong); }

        /* Decorative elements — hidden */
        .panel-screws { display: none; }
        .screw { display: none; }
        .vent-bar { display: none; }

        /* --- LED Indicators --- */
        .led {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
            background: var(--led-grey);
            position: relative;
        }
        .led::before {
            content: '';
            display: block;
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: radial-gradient(circle, currentColor 0%, transparent 70%);
            opacity: 0.3;
            z-index: -1;
        }
        .led.healthy { background: var(--led-green); }
        .led.unhealthy, .led.unreachable { background: var(--led-red); }
        .led.degraded { background: var(--led-amber); }
        .led.checking, .led.stale { background: var(--led-grey); }
        .led.loading { animation: led-pulse 1.2s ease-in-out infinite; }

        @keyframes led-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* --- Status Bar: removed (now in sidebar) --- */

        /* --- Terminal --- */
        .terminal-section {
            background: var(--bg-surface);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
        }

        .terminal-toolbar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border-color);
        }

        .terminal-toolbar-label {
            font-weight: 600;
            margin-right: 0.2rem;
            white-space: nowrap;
            color: var(--text-primary);
        }

        .terminal-filters {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }

        .terminal-filter-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-tertiary);
            padding: 0.2rem 0.5rem;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.12s ease;
            border-radius: var(--radius-pill);
        }

        .terminal-filter-btn.active {
            color: var(--text-primary);
            background: var(--bg-surface-hover);
            border-color: var(--border-color-strong);
        }

        .terminal-filter-btn.active.level-warning { color: var(--led-amber); }
        .terminal-filter-btn.active.level-error { color: var(--led-red); }
        .terminal-filter-btn.active.level-critical { color: var(--led-red); }

        .terminal-conn {
            margin-left: auto;
            font-size: 0.75rem;
            letter-spacing: 0.06em;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-weight: 500;
        }
        .terminal-conn.live { color: var(--led-green); }
        .terminal-conn.connecting { color: var(--led-amber); }
        .terminal-conn.stale { color: var(--led-red); }

        .terminal-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.2rem 0.55rem;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.04em;
            cursor: pointer;
            border-radius: var(--radius-pill);
            transition: all 0.12s ease;
            margin-left: 0.2rem;
        }
        .terminal-toggle:hover { background: var(--bg-surface-hover); border-color: var(--border-color-strong); }
        .terminal-toggle:active { background: var(--bg-input); }

        /* Terminal bezel — flattened */
        .terminal-screen-bezel {
            margin: 0;
            padding: 0;
            border-radius: 0;
            background: transparent;
        }

        .terminal-body {
            padding: 0.5rem 0.75rem;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            overflow-y: auto;
            height: 120px;
            transition: height 0.2s ease;
            background: var(--bg-terminal);
            border-radius: 0;
        }
        .terminal-body.expanded { height: 50vh; }

        .term-line {
            display: grid;
            grid-template-columns: 56px 170px minmax(0, 1fr);
            gap: 0.4rem;
            min-height: 18px;
            align-items: start;
            border-bottom: 1px solid rgba(74, 246, 38, 0.06);
            padding-bottom: 0.2rem;
            word-break: break-word;
        }
        .term-line.system { color: var(--text-tertiary); }
        .term-level { color: var(--led-green); }
        .term-level.warning { color: var(--led-amber); }
        .term-level.error, .term-level.critical { color: var(--led-red); }
        .term-src { color: var(--text-secondary); }
        .term-msg { color: var(--text-primary); }

        /* --- Dashboard Grid --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.75rem;
        }

        /* --- Panels --- */
        .panel {
            background: var(--bg-surface);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            padding: 0;
            position: relative;
            overflow: hidden;
            transition: border-color 0.15s ease;
        }
        .panel:hover { border-color: var(--border-color-strong); }

        .panel-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.65rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .panel-title .refresh-info {
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-tertiary);
        }

        /* --- Tables --- */
        .table-wrap {
            overflow-x: auto;
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            background: var(--bg-surface);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9375rem;
        }

        th {
            text-align: left;
            padding: 0.5rem 0.65rem;
            background: var(--bg-input);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-size: 0.8125rem;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        td {
            padding: 0.5rem 0.65rem;
            border-bottom: 1px solid var(--border-color-subtle);
            vertical-align: top;
        }

        tr:hover td { background: var(--bg-surface-hover); }
        td code { color: var(--text-primary); font-size: 0.875rem; font-weight: 500; }

        /* --- Backend Cards --- */
        .backends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 0.5rem;
        }

        .backend-card {
            background: var(--bg-surface);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            transition: border-color 0.12s ease, background-color 0.12s ease;
            cursor: pointer;
            position: relative;
        }
        .backend-card:hover {
            border-color: var(--border-color-strong);
            background: var(--bg-surface-hover);
        }
        .backend-card.active {
            border-color: var(--led-green);
            background: var(--bg-surface-hover);
            box-shadow: 0 0 6px rgba(74, 246, 38, 0.2);
        }

        .backend-name {
            font-weight: 600;
            font-size: 0.9375rem;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--text-primary);
        }

        .backend-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
            min-height: 2em;
        }

        .backend-health-url {
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.8125rem;
            color: var(--text-tertiary);
            margin-top: 0.2rem;
            letter-spacing: 0.02em;
        }

        /* --- Model Toolbar --- */
        .model-toolbar {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            flex-wrap: wrap;
            margin-bottom: 0.65rem;
        }

        .model-load-defaults {
            display: flex;
            align-items: flex-end;
            gap: 0.55rem;
            flex-wrap: wrap;
        }

        .load-default-field {
            display: flex;
            flex-direction: column;
            gap: 0.18rem;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.75rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--text-tertiary);
        }

        .load-default-input {
            min-height: 32px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-pill);
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.85rem;
            letter-spacing: 0.02em;
            width: 96px;
        }
        .load-default-input.prompt { width: min(540px, 72vw); }

        .model-action-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            letter-spacing: 0.02em;
        }
        .model-action-status.error { color: var(--led-red); }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 36px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-btn);
            padding: 0.35rem 0.75rem;
            background: var(--bg-surface);
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.1s ease, border-color 0.1s ease;
        }
        .btn:hover:enabled { background: var(--bg-surface-hover); border-color: var(--border-color-strong); }
        .btn:active:enabled { background: var(--bg-input); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn.load { color: var(--led-green); }
        .btn.unload { color: var(--accent); }

        /* --- Status Pills --- */
        .status-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 26px;
            min-width: 72px;
            padding: 0.15rem 0.55rem;
            font-size: 0.8125rem;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 500;
            border-radius: var(--radius-pill);
            border: 1px solid var(--border-color);
            background: transparent;
        }
        .status-pill.loaded { color: var(--led-green); border-color: rgba(74, 246, 38, 0.3); background: rgba(74, 246, 38, 0.05); }
        .status-pill.loading { color: var(--led-blue); border-color: rgba(0, 170, 255, 0.3); background: rgba(0, 170, 255, 0.05); }
        .status-pill.unloading { color: var(--led-amber); border-color: rgba(255, 170, 0, 0.3); background: rgba(255, 170, 0, 0.05); }
        .status-pill.unloaded { color: var(--text-tertiary); }
        .status-pill.failed { color: var(--led-red); border-color: rgba(255, 51, 51, 0.3); background: rgba(255, 51, 51, 0.05); }
        .status-pill.unknown { color: var(--led-blue); }

        .model-actions {
            display: inline-flex;
            gap: 0.45rem;
            flex-wrap: nowrap;
            white-space: nowrap;
        }

        .model-link {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-pill);
            padding: 0.3rem 0.55rem;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        .model-link:hover { background: var(--bg-surface-hover); border-color: var(--border-color-strong); }
        .model-link:active { background: var(--bg-input); }

        .device-badge {
            display: inline-flex;
            align-items: center;
            min-height: 22px;
            padding: 0.1rem 0.45rem;
            color: var(--text-secondary);
            background: var(--bg-input);
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            border-radius: var(--radius-pill);
            border: 1px solid var(--border-color);
        }
        .device-badge.gpu { color: var(--led-blue); }

        /* --- Endpoint Inspector --- */
        .endpoint-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 280px;
            gap: 0.75rem;
            align-items: start;
        }

        .backend-endpoints-hud {
            margin-top: 0.75rem;
            padding: 0.75rem;
        }

        .endpoint-selected-backend {
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .endpoint-shell {
            position: relative;
            background: var(--bg-surface);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
        }

        .endpoint-group { margin-bottom: 0.75rem; }
        .endpoint-group:last-child { margin-bottom: 0; }

        .endpoint-empty {
            color: var(--text-tertiary);
            font-size: 0.85rem;
            letter-spacing: 0.02em;
            padding: 0.3rem 0;
        }

        .endpoint-group-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.3rem;
            padding-bottom: 0.2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .endpoint-row {
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.875rem;
            padding: 0.2rem 0;
            display: flex;
            gap: 0.6rem;
        }

        .ep-method {
            font-weight: 600;
            min-width: 3.5rem;
            text-align: right;
            letter-spacing: 0.04em;
        }
        .ep-method.get { color: var(--led-green); }
        .ep-method.post { color: var(--led-amber); }
        .ep-method.delete { color: var(--led-red); }
        .ep-path { color: var(--text-primary); }

        /* --- Operator Links --- */
        /* --- Focus Ring --- */
        .focusable:focus-visible,
        button:focus-visible,
        a:focus-visible {
            outline: 2px solid var(--led-green);
            outline-offset: 2px;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* --- Model Modal --- */
        .model-modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: var(--bg-overlay);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .model-modal.open { display: flex; }

        .model-modal-panel {
            width: min(980px, 100%);
            max-height: 88vh;
            overflow: auto;
            background: var(--bg-elevated);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            box-shadow: 0 0 30px rgba(74, 246, 38, 0.08);
            padding: 0;
        }

        .model-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.8rem;
            margin-bottom: 0.6rem;
        }

        .model-modal-title {
            font-size: 1.0625rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--text-primary);
        }

        .model-modal-live {
            margin-bottom: 0.6rem;
            font-size: 0.75rem;
            letter-spacing: 0.02em;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
        }
        .model-modal-live.stale { color: var(--led-red); }

        .model-meta-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.7rem;
        }

        .model-meta-item {
            background: var(--bg-input);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            padding: 0.45rem 0.55rem;
        }

        .model-meta-label {
            font-size: 0.6875rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-tertiary);
            margin-bottom: 0.15rem;
            font-weight: 600;
        }

        .model-meta-value {
            font-size: 0.875rem;
            color: var(--text-primary);
            word-break: break-word;
        }

        .model-arg-grid {
            margin-top: 0.2rem;
            margin-bottom: 0.75rem;
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .model-arg-row {
            display: grid;
            grid-template-columns: 220px minmax(0, 1fr);
            gap: 0.6rem;
            padding: 0.38rem 0.6rem;
            border-bottom: 1px solid var(--border-color-subtle);
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.85rem;
        }
        .model-arg-row:last-child { border-bottom: 0; }

        .model-arg-key {
            color: var(--led-green);
            text-transform: lowercase;
            word-break: break-all;
        }

        .model-arg-value {
            color: var(--text-primary);
            word-break: break-word;
        }

        .model-arg-help {
            margin-top: 0.2rem;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            letter-spacing: 0.02em;
        }

        .model-profile-shell {
            background: var(--bg-surface);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            padding: 0.6rem;
            margin-bottom: 0.75rem;
        }

        .model-source-shell {
            background: var(--bg-surface);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            padding: 0.6rem;
            margin-bottom: 0.75rem;
        }

        .model-source-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.5rem;
        }

        .model-source-card {
            background: var(--bg-input);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.6rem;
        }

        .model-source-title {
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--led-green);
            margin-bottom: 0.3rem;
            font-weight: 700;
        }

        .model-source-row {
            display: flex;
            justify-content: space-between;
            gap: 0.6rem;
            padding: 0.1rem 0;
            border-bottom: 1px solid var(--border-color-subtle);
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.8125rem;
        }
        .model-source-row:last-child { border-bottom: 0; }

        .model-source-key {
            color: var(--text-secondary);
            text-transform: lowercase;
            word-break: break-word;
        }

        .model-source-value {
            color: var(--text-primary);
            text-align: right;
            word-break: break-word;
        }

        .model-source-meta {
            margin-top: 0.3rem;
            font-size: 0.6875rem;
            letter-spacing: 0.03em;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
        }

        .model-source-link {
            color: var(--led-green);
            text-decoration: none;
            border-bottom: 1px dashed rgba(74, 246, 38, 0.4);
        }
        .model-source-link:hover {
            color: var(--text-primary);
            border-bottom-color: rgba(74, 246, 38, 0.6);
        }

        .model-profile-grid {
            display: grid;
            gap: 0.6rem;
        }

        .model-profile-row {
            background: var(--bg-input);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.6rem;
        }

        .model-profile-topline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }

        .model-profile-name {
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-primary);
            font-weight: 600;
        }

        .model-profile-scope {
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-tertiary);
            padding: 0.08rem 0.3rem;
            border-radius: var(--radius-pill);
            border: 1px solid var(--border-color);
        }

        .model-profile-input,
        .model-profile-select,
        .model-profile-textarea {
            width: 100%;
            border: 1px solid var(--border-color);
            background: var(--bg-surface);
            color: var(--text-primary);
            padding: 0.35rem 0.45rem;
            border-radius: var(--radius-pill);
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.85rem;
            letter-spacing: 0.02em;
        }
        .model-profile-textarea { min-height: 76px; resize: vertical; }

        .model-profile-range-wrap { display: grid; gap: 0.3rem; }

        .model-profile-slider {
            width: 100%;
            accent-color: var(--led-green);
            cursor: pointer;
        }

        .model-profile-range-meta {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 0.5rem;
            align-items: center;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.6875rem;
            letter-spacing: 0.03em;
            color: var(--text-tertiary);
        }
        .model-profile-range-meta span:last-child { text-align: right; }

        .model-profile-range-value {
            color: var(--led-green);
            text-align: center;
            font-weight: 600;
        }

        .model-profile-help {
            margin-top: 0.3rem;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            letter-spacing: 0.02em;
        }

        .model-profile-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.65rem;
        }

        .model-profile-status {
            font-size: 0.8125rem;
            color: var(--led-green);
            letter-spacing: 0.02em;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
        }
        .model-profile-status.error { color: var(--led-red); }

        .model-profile-notes {
            margin-top: 0.6rem;
            border-top: 1px solid var(--border-color);
            padding-top: 0.45rem;
            display: grid;
            gap: 0.3rem;
        }

        .model-profile-note {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            letter-spacing: 0.02em;
        }

        .model-json-wrap {
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            overflow: auto;
        }

        .model-json {
            margin: 0;
            padding: 0.65rem;
            color: var(--text-primary);
            font-size: 0.85rem;
            line-height: 1.4;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            white-space: pre;
        }

        /* --- App Shell Layout --- */
        .app-shell {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .sidebar {
            width: 240px;
            flex-shrink: 0;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            box-shadow: var(--glow-border);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 20;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-brand {
            font-weight: 800;
            font-size: 1rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-primary);
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0.5rem;
            flex: 1;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            padding: 0.6rem 0.75rem;
            padding-left: calc(0.75rem + 3px);
            border-radius: 0;
            color: var(--text-secondary);
            font-size: 0.9375rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            transition: background-color 0.1s ease, color 0.1s ease, border-color 0.1s ease;
            text-decoration: none;
            border: none;
            border-left: 3px solid transparent;
        }

        .sidebar-link:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
            border-left-color: var(--border-color-strong);
        }

        .sidebar-link.active {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
            border-left-color: var(--led-green);
            text-shadow: var(--glow-text);
        }

        .sidebar-link svg {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
            opacity: 0.6;
        }

        .sidebar-link.active svg { opacity: 1; }

        .sidebar-footer {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .sidebar-footer code {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 700;
        }

        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 1rem;
            min-height: 100vh;
        }

        /* --- View Containers --- */
        .view { display: none; }
        .view.active { display: block; }

        .view-header {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .view-title {
            font-size: 1.125rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-primary);
        }

        .refresh-info {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        /* --- Overview Cards --- */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .overview-card {
            background: var(--bg-surface);
            border-radius: var(--radius-panel);
            border: 1px solid var(--border-color);
            padding: 0.85rem 1rem;
            transition: border-color 0.15s ease;
        }

        .overview-card:hover { border-color: var(--border-color-strong); }

        .overview-card-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.25rem;
        }

        .overview-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .overview-card-value code {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .overview-card-sub {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: 0.15rem;
        }

        .overview-terminal-preview {
            overflow: hidden;
        }

        .overview-terminal-preview .terminal-toolbar {
            border-bottom: 1px solid var(--border-color);
        }

        .overview-terminal-preview .terminal-body {
            height: 120px;
        }

        /* --- Mobile Topbar + Hamburger --- */
        .mobile-topbar { display: none; }
        .sidebar-backdrop { display: none; }

        .mobile-topbar-title {
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            color: var(--text-primary);
        }

        .hamburger-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-btn);
            color: var(--text-secondary);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .hamburger-btn:active { background: var(--bg-surface-hover); }



        /* --- Terminal full-viewport mode --- */
        #view-terminal {
            display: none;
            flex-direction: column;
            height: calc(100vh - 2rem);  /* minus main-content padding */
        }
        #view-terminal.active {
            display: flex;
        }
        #view-terminal .view-header {
            flex-shrink: 0;
            margin-bottom: 0.5rem;
        }
        #view-terminal .terminal-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        #view-terminal .terminal-toolbar {
            flex-shrink: 0;
        }
        #view-terminal .terminal-screen-bezel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        #view-terminal .terminal-body {
            flex: 1;
            height: auto;
            min-height: 0;
        }
        #view-terminal .terminal-body.expanded {
            height: auto;
        }

        /* --- API Docs full-viewport mode --- */
        #view-api-docs {
            display: none;
            flex-direction: column;
            height: calc(100vh - 2rem);
        }
        #view-api-docs.active {
            display: flex;
        }
        #view-api-docs .view-header {
            flex-shrink: 0;
            margin-bottom: 0.5rem;
        }
        .api-docs-tabs {
            flex-shrink: 0;
            display: flex;
            gap: 0.35rem;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .api-docs-tab {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-tertiary);
            font-family: inherit;
            font-size: 0.8125rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 0.4rem 0.75rem;
            min-height: 36px;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.1s ease, border-color 0.1s ease, color 0.1s ease;
        }
        .api-docs-tab:hover {
            color: var(--text-primary);
            background: var(--bg-surface-hover);
            border-color: var(--border-color-strong);
            box-shadow: var(--glow-border);
        }
        .api-docs-tab.active {
            color: var(--text-primary);
            background: var(--bg-surface-hover);
            border-color: var(--border-color-strong);
            text-shadow: var(--glow-text);
        }
        .api-docs-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            margin-top: 0.5rem;
        }
        .api-docs-iframe {
            flex: 1;
            width: 100%;
            border: none;
            min-height: 0;
            filter: var(--iframe-filter);
        }
        .api-docs-json-panel {
            flex: 1;
            overflow: auto;
            min-height: 0;
            display: none;
        }
        .api-docs-json-panel.visible {
            display: block;
        }
        .api-docs-json {
            margin: 0;
            padding: 1rem;
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.8125rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 100%;
        }
        .api-docs-loader {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-surface);
            color: var(--text-tertiary);
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            z-index: 2;
        }
        .api-docs-loader.hidden {
            display: none;
        }
        @keyframes api-docs-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .api-docs-loader span {
            animation: api-docs-blink 1.2s ease-in-out infinite;
        }

        /* --- Model Search --- */
        .model-search-input {
            min-height: 36px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            color: var(--text-primary);
            padding: 0.3rem 0.65rem;
            border-radius: var(--radius-btn);
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace;
            font-size: 0.85rem;
            letter-spacing: 0.02em;
            width: min(280px, 50vw);
            transition: border-color 0.12s ease;
        }
        .model-search-input::placeholder { color: var(--text-tertiary); }
        .model-search-input:focus {
            outline: none;
            border-color: var(--led-green);
            box-shadow: var(--glow-border);
        }

        /* --- Overview Error Summary Card --- */
        .overview-card-value.warn { color: var(--led-amber); }
        .overview-card-value.err { color: var(--led-red); }

        /* --- Retry Button (inline in error states) --- */
        .retry-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.2rem 0.5rem;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: var(--radius-btn);
            margin-left: 0.5rem;
            transition: all 0.12s ease;
        }
        .retry-btn:hover {
            background: var(--bg-surface-hover);
            border-color: var(--border-color-strong);
            color: var(--text-primary);
        }

        /* --- Keyboard Shortcut Hint --- */
        .kbd-hint {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-panel);
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            z-index: 90;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .kbd-hint.visible { opacity: 1; pointer-events: auto; }
        .kbd-hint kbd {
            display: inline-block;
            background: var(--bg-surface);
            border: 1px solid var(--border-color-strong);
            border-radius: 2px;
            padding: 0.05rem 0.3rem;
            font-family: inherit;
            font-size: 0.7rem;
            color: var(--text-primary);
            margin: 0 0.1rem;
        }

        /* --- Tablet --- */
        @media (max-width: 1120px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .endpoint-grid { grid-template-columns: 1fr; }
        }

        /* Light theme: enabled via [data-theme="light"] on <html> */



        /* --- Mobile --- */
        @media (max-width: 700px) {
            body { padding: 0; }

            /* Sidebar: off-screen, slides in */
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.25s cubic-bezier(0.32, 0.72, 0, 1);
                z-index: 50;
            }
            .sidebar.open { transform: translateX(0); }

            .sidebar-backdrop {
                display: block;
                position: fixed;
                inset: 0;
                z-index: 49;
                background: var(--bg-backdrop);
                backdrop-filter: blur(4px);
                -webkit-backdrop-filter: blur(4px);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.25s ease;
            }
            .sidebar-backdrop.active {
                opacity: 1;
                pointer-events: auto;
            }

            /* Mobile topbar visible */
            .mobile-topbar {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.6rem 0.85rem;
                background: var(--bg-surface);
                border-bottom: 1px solid var(--border-color);
                position: sticky;
                top: 0;
                z-index: 30;
            }

            .main-content {
                margin-left: 0;
                padding: 0.75rem;
            }

            /* Panels: no hover effect on touch */
            .panel:hover, .neu-panel:hover { border-color: var(--border-color); }
            .backend-card:hover { background: var(--bg-surface); }

            /* Terminal mobile: full viewport */
            .terminal-section { border-radius: 0; }
            #view-terminal { height: calc(100vh - 3.5rem); }  /* minus topbar + padding */
            #view-terminal .view-header { margin-bottom: 0.35rem; }
            .terminal-toolbar {
                flex-wrap: nowrap;
                gap: 0.5rem;
                position: relative;
                font-size: 0.75rem;
                padding: 0.55rem 0.85rem;
            }
            .terminal-toolbar-label { font-size: 0.75rem; font-weight: 700; }
            .terminal-body {
                height: auto;
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
                gap: 0.3rem;
            }
            .terminal-body.expanded { height: auto; }
            .term-line {
                display: flex !important;
                flex-wrap: wrap;
                gap: 0.3rem 0.5rem;
                padding-bottom: 0.35rem;
                font-size: 0.85rem;
            }
            .term-level { flex-shrink: 0; }
            .term-src { flex-shrink: 0; max-width: 180px; overflow: hidden; text-overflow: ellipsis; }
            .term-msg { flex-basis: 100%; word-break: break-word; }

            /* API docs mobile */
            #view-api-docs { height: calc(100vh - 3.5rem); }
            #view-api-docs .view-header { margin-bottom: 0.35rem; }
            .api-docs-tabs { gap: 0.25rem; }
            .api-docs-tab {
                min-height: 44px;
                padding: 0.35rem 0.55rem;
                font-size: 0.8rem;
            }

            /* Overview grid: stack on mobile */
            .overview-grid { grid-template-columns: 1fr 1fr; }

            /* Dashboard grid: stack */
            .dashboard-grid { grid-template-columns: 1fr; }

            /* Backends grid */
            .backends-grid { grid-template-columns: 1fr; }

            /* Table → card layout on mobile */
            .table-wrap { border-radius: var(--radius-panel); border: none; background: transparent; }
            #view-models table,
            #view-models thead,
            #view-models tbody,
            #view-models th,
            #view-models td,
            #view-models tr {
                display: block;
            }
            #view-models thead { display: none; }
            #view-models tr {
                background: var(--bg-surface);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-panel);
                padding: 0.65rem 0.75rem;
                margin-bottom: 0.5rem;
            }
            #view-models td {
                border-bottom: none;
                padding: 0.15rem 0;
            }
            #view-models td:first-child { margin-bottom: 0.3rem; }
            .model-search-input { width: 100%; }

            /* Buttons: 44px min touch target */
            .btn {
                min-height: 44px;
                border-radius: var(--radius-btn);
                font-size: 0.85rem;
            }
            .terminal-filter-btn {
                min-height: 44px;
                padding: 0.35rem 0.65rem;
                font-size: 0.8rem;
            }

            /* Model modal as bottom sheet on mobile */
            .model-modal { align-items: flex-end; padding: 0; z-index: 100; }
            .model-modal-panel {
                width: 100%;
                max-height: 92vh;
                border-radius: 0;
                border: none;
                border-top: 1px solid var(--border-color);
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }
            .model-modal-header {
                position: sticky; top: 0;
                background: var(--bg-elevated);
                z-index: 1;
                padding-top: 0.75rem;
            }
            .model-modal-title { font-size: 0.85rem; }

            /* View header */
            .view-header { flex-wrap: wrap; }
        }


        /* --- Reduced Motion --- */
        @media (prefers-reduced-motion: reduce) {
            .led.loading { animation: none !important; }
            .terminal-body { transition: none; }
            .sidebar { transition: none; }
            .sidebar-backdrop { transition: none; }
            .terminal-conn.live::after { animation: none; }
            body::before { display: none; }
        }

        /* --- Light theme element overrides --- */
        [data-theme="light"] .status-pill.loaded { border-color: rgba(34, 168, 34, 0.4); background: rgba(34, 168, 34, 0.08); }
        [data-theme="light"] .status-pill.loading { border-color: rgba(0, 136, 204, 0.4); background: rgba(0, 136, 204, 0.08); }
        [data-theme="light"] .status-pill.unloading { border-color: rgba(204, 136, 0, 0.4); background: rgba(204, 136, 0, 0.08); }
        [data-theme="light"] .status-pill.failed { border-color: rgba(204, 34, 34, 0.4); background: rgba(204, 34, 34, 0.08); }
        [data-theme="light"] .backend-card.active { box-shadow: 0 0 0 2px rgba(34, 168, 34, 0.25); }
        [data-theme="light"] .term-line { border-bottom-color: rgba(26, 92, 26, 0.1); }
        [data-theme="light"] .model-source-link { border-bottom-color: rgba(26, 92, 26, 0.3); }
        [data-theme="light"] .model-source-link:hover { border-bottom-color: rgba(26, 92, 26, 0.5); }
        [data-theme="light"] .terminal-conn.live::after { color: var(--led-green); }
        [data-theme="light"] .model-modal-panel { box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12); }
        [data-theme="light"] .sidebar-link.active { background: rgba(34, 168, 34, 0.08); }
        [data-theme="light"] .overview-card:hover { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); }

        /* --- Theme toggle button --- */
        .theme-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-btn);
            color: var(--text-tertiary);
            padding: 0.3rem 0.55rem;
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.12s ease;
            margin-top: 0.5rem;
        }
        .theme-toggle:hover { color: var(--text-primary); border-color: var(--border-color-strong); }

        /* --- Terminal glow on titles only --- */
        .sidebar-brand,
        .view-title {
            text-shadow: var(--glow-text);
        }

        /* --- Sidebar glyph icons --- */
        .sidebar-glyph {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            font-size: 1rem;
            font-weight: 800;
            flex-shrink: 0;
            opacity: 0.5;
            color: var(--text-secondary);
        }
        .sidebar-link:hover .sidebar-glyph {
            opacity: 0.8;
        }
        .sidebar-link.active .sidebar-glyph {
            opacity: 1;
            color: var(--led-green);
            text-shadow: var(--glow-text);
        }

        /* --- Cursor blink --- */
        @keyframes cursor-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .terminal-conn.live::after {
            content: ' \2588';
            animation: cursor-blink 1s step-end infinite;
        }

        /* --- Overview card hover glow --- */
        .overview-card:hover {
            border-color: var(--border-color-strong);
            box-shadow: var(--glow-border);
        }

        /* --- Backend card hover glow --- */
        .backend-card:hover {
            border-color: var(--border-color-strong);
            background: var(--bg-surface-hover);
            box-shadow: var(--glow-border);
        }

        /* --- Button hover glow --- */
        .btn:hover:enabled {
            background: var(--bg-surface-hover);
            border-color: var(--text-secondary);
            box-shadow: var(--glow-border);
        }

    </style>
</head>
<body>
    <!-- Mobile top bar (hidden on desktop) -->
    <div class="mobile-topbar">
        <button id="hamburger-btn" class="hamburger-btn" type="button" aria-label="Open navigation">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                <path d="M2 4h14M2 9h14M2 14h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
        </button>
        <span class="mobile-topbar-title">synapse~$</span>
        <span id="overall-dot-mobile" class="led status-led __OVERALL_STATUS_CLASS__"></span>
    </div>

    <div class="app-shell">
        <!-- Sidebar -->
        <nav id="sidebar" class="sidebar" aria-label="Main navigation">
            <div class="sidebar-header">
                <span id="overall-dot" class="led status-led __OVERALL_STATUS_CLASS__"></span>
                <span class="sidebar-brand">SYNAPSE://GW</span>
            </div>
            <div class="sidebar-nav">
                <a href="#/overview" class="sidebar-link active" data-view="overview">
                    <span class="sidebar-glyph">::</span>
                    OVERVIEW
                </a>
                <a href="#/backends" class="sidebar-link" data-view="backends">
                    <span class="sidebar-glyph">[]</span>
                    NODES
                </a>
                <a href="#/models" class="sidebar-link" data-view="models">
                    <span class="sidebar-glyph">&lt;&gt;</span>
                    MODELS
                </a>
                <a href="#/terminal" class="sidebar-link" data-view="terminal">
                    <span class="sidebar-glyph">&gt;_</span>
                    TERMINAL
                </a>
                <a href="#/api-docs" class="sidebar-link" data-view="api-docs">
                    <span class="sidebar-glyph">{}</span>
                    API-DOCS
                </a>
            </div>
            <div class="sidebar-footer">
                Uptime <code id="uptime">__UPTIME__</code> &middot; <code>__BACKEND_COUNT__</code> backends
                <br>
                <button id="theme-toggle" class="theme-toggle" type="button" aria-label="Toggle light/dark theme">
                    <span id="theme-toggle-icon">&#9790;</span> <span id="theme-toggle-label">LIGHT</span>
                </button>
            </div>
        </nav>

        <!-- Sidebar mobile backdrop -->
        <div id="sidebar-backdrop" class="sidebar-backdrop"></div>

        <!-- Main content area -->
        <div class="main-content">

            <!-- VIEW: Overview -->
            <section id="view-overview" class="view active">
                <div class="view-header">
                    <h1 class="view-title">&gt; OVERVIEW</h1>
                    <span class="refresh-info" id="overview-refresh-info" aria-live="polite">poll: 30s</span>
                </div>
                <div class="overview-grid">
                    <div class="overview-card">
                        <div class="overview-card-label">STATUS</div>
                        <div class="overview-card-value">
                            <span id="overview-dot" class="led status-led __OVERALL_STATUS_CLASS__"></span>
                            <span id="overview-status-text">checking...</span>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-label">NODES</div>
                        <div class="overview-card-value" id="overview-backends-value">__BACKEND_COUNT__</div>
                        <div class="overview-card-sub" id="overview-backends-sub">health: pending</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-label">UPTIME</div>
                        <div class="overview-card-value"><code id="overview-uptime">__UPTIME__</code></div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-label">MODELS</div>
                        <div class="overview-card-value" id="overview-models-value">--</div>
                        <div class="overview-card-sub" id="overview-models-sub">loading...</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-label">ERRORS</div>
                        <div class="overview-card-value" id="overview-errors-value">0</div>
                        <div class="overview-card-sub" id="overview-errors-sub">no issues detected</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-label">LAST CHECK</div>
                        <div class="overview-card-value" id="overview-lastcheck-value" style="font-size:1rem">--</div>
                        <div class="overview-card-sub" id="overview-lastcheck-sub">health poll: 30s</div>
                    </div>
                </div>
                <div class="overview-terminal-preview neu-panel">
                    <div class="terminal-toolbar" style="pointer-events:none;">
                        <span class="terminal-toolbar-label">STDOUT</span>
                        <a href="#/terminal" class="terminal-toggle" style="pointer-events:auto;">tail -f &rarr;</a>
                    </div>
                    <div id="overview-terminal-preview" class="terminal-body" style="height:120px;pointer-events:none;opacity:0.75;"></div>
                </div>
            </section>

            <!-- VIEW: Backends -->
            <section id="view-backends" class="view">
                <div class="view-header">
                    <h1 class="view-title">&gt; NODE HEALTH</h1>
                    <span class="refresh-info" id="refresh-info" aria-live="polite">poll: 30s</span>
                </div>
                <div class="backends-grid" id="backends-grid">__BACKEND_CARDS__</div>
                <div class="endpoint-shell backend-endpoints-hud">
                    <div class="panel-title">
                        ENDPOINT PROBE
                        <span id="endpoint-total" style="font-weight:400;font-size:0.75rem;color:var(--text-tertiary)">0 routes</span>
                    </div>
                    <div id="endpoint-selected-backend" class="endpoint-selected-backend">-- select node --</div>
                    <div id="backend-endpoint-groups" aria-live="polite"></div>
                </div>
            </section>

            <!-- VIEW: Models -->
            <section id="view-models" class="view">
                <div class="view-header">
                    <h1 class="view-title">&gt; MODEL REGISTRY</h1>
                    <span class="refresh-info" id="models-refresh-info" aria-live="polite">poll: 15s</span>
                </div>
                <div class="model-toolbar">
                    <input id="model-search" class="model-search-input" type="search" placeholder="filter models..." aria-label="Filter models by name" autocomplete="off">
                    <button id="refresh-models-btn" class="btn focusable">[ refresh ]</button>
                    <span id="model-action-status" class="model-action-status" aria-live="polite">idle</span>
                </div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>MODEL</th><th>STATE</th><th>CMD</th>
                            </tr>
                        </thead>
                        <tbody id="models-table-body">
                            <tr>
                                <td colspan="3" style="color:var(--text-tertiary)">fetching registry...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- VIEW: Terminal -->
            <section id="view-terminal" class="view">
                <div class="view-header">
                    <h1 class="view-title">&gt; STDOUT</h1>
                    <span id="terminal-conn" class="terminal-conn connecting">connecting</span>
                </div>
                <section class="terminal-section">
                    <div class="terminal-toolbar">
                        <span class="terminal-toolbar-label">LIVE</span>
                        <div class="terminal-filters">
                            <button class="terminal-filter-btn active" data-level="INFO">INFO</button>
                            <button class="terminal-filter-btn active level-warning" data-level="WARNING">WARN</button>
                            <button class="terminal-filter-btn active level-error" data-level="ERROR">ERR</button>
                            <button class="terminal-filter-btn active level-critical" data-level="CRITICAL">CRIT</button>
                        </div>
                    </div>
                    <div class="terminal-screen-bezel">
                        <div id="terminal-feed" class="terminal-body" role="log" aria-live="polite" aria-relevant="additions text">
                            <div class="term-line system"><span class="term-level">INFO</span><span class="term-src">gateway.bootstrap</span><span class="term-msg">stream ready</span></div>
                        </div>
                    </div>
                </section>
            </section>

            <!-- VIEW: API Docs -->
            <section id="view-api-docs" class="view">
                <div class="view-header">
                    <h1 class="view-title">&gt; API SCHEMA</h1>
                </div>
                <div class="api-docs-tabs" role="tablist" aria-label="API documentation tabs">
                    <button class="api-docs-tab active focusable" role="tab" aria-selected="true" aria-controls="api-docs-content-panel" data-doc-src="/docs" data-doc-type="iframe">[ /DOCS ]</button>
                    <button class="api-docs-tab focusable" role="tab" aria-selected="false" aria-controls="api-docs-content-panel" data-doc-src="/redoc" data-doc-type="iframe">[ /REDOC ]</button>
                    <button class="api-docs-tab focusable" role="tab" aria-selected="false" aria-controls="api-docs-content-panel" data-doc-src="/openapi.json" data-doc-type="json">[ /OPENAPI.JSON ]</button>
                    <button class="api-docs-tab focusable" role="tab" aria-selected="false" aria-controls="api-docs-content-panel" data-doc-src="/health" data-doc-type="json">[ /HEALTH ]</button>
                </div>
                <div class="api-docs-content" id="api-docs-content-panel" role="tabpanel">
                    <div class="api-docs-loader" id="api-docs-loader"><span>LOADING...</span></div>
                    <iframe class="api-docs-iframe" id="api-docs-iframe" title="API documentation" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
                    <div class="api-docs-json-panel" id="api-docs-json-panel">
                        <pre class="api-docs-json" id="api-docs-json"></pre>
                    </div>
                </div>
            </section>

        </div><!-- .main-content -->
    </div><!-- .app-shell -->

    <!-- Model modal (unchanged, stays at body level) -->
    <div id="model-modal" class="model-modal" aria-hidden="true">
        <section class="model-modal-panel" role="dialog" aria-modal="true" aria-labelledby="model-modal-title">
            <div class="model-modal-header">
                <h2 id="model-modal-title" class="model-modal-title">MODEL INFO</h2>
                <button id="model-modal-close" class="btn unload focusable" type="button">[ close ]</button>
            </div>
            <div id="model-modal-subtitle" class="endpoint-selected-backend">-- no model selected --</div>
            <div id="model-modal-live" class="model-modal-live" aria-live="polite">registry: idle</div>
            <div id="model-modal-content"></div>
        </section>
    </div>
    <div id="sr-live-region" class="sr-only" aria-live="polite"></div>

    <!-- Keyboard shortcut hint overlay -->
    <div id="kbd-hint" class="kbd-hint" aria-hidden="true">
        <kbd>1</kbd>-<kbd>5</kbd> views &middot; <kbd>r</kbd> refresh &middot; <kbd>/</kbd> search &middot; <kbd>t</kbd> theme &middot; <kbd>?</kbd> help
    </div>

    <script>
        /* --- Theme: initialize immediately to prevent FOUC --- */
        (function() {
            let saved = null;
            try { saved = localStorage.getItem('synapse_theme'); } catch (e) {}
            const theme = saved || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
            document.documentElement.dataset.theme = theme;
        })();

        let uptimeSeconds = __UPTIME_SECONDS__;
        let modelActionInFlight = false;
        let healthRequestToken = 0;
        let modelsRequestToken = 0;
        let latestHealthToken = 0;
        let latestModelsToken = 0;
        let healthAbortController = null;
        let modelsAbortController = null;
        let healthStaleAnnounced = false;
        let modelsStaleAnnounced = false;

        const healthState = {
            status: 'checking',
            healthy: 0,
            total: 0,
            stale: true,
            lastSuccessMs: 0,
        };

        const modelState = {
            loaded: 0,
            loading: 0,
            failed: 0,
            total: 0,
            stale: true,
            lastSuccessMs: 0,
        };
        const modelRegistry = new Map();
        const modelProfileSchemaCache = new Map();
        const modelPendingActions = new Map();
        let modelRegistryRefreshedAt = 0;
        let activeModelModalId = '';
        let selectedBackend = '';
        const TERMINAL_FEED_MODE = "__TERMINAL_FEED_MODE__";
        const TERMINAL_INSTANCE_ID = "__INSTANCE_ID__";
        const TERMINAL_MAX_LINES = 300;
        const TERMINAL_RECONNECT_MS = 2500;
        let terminalEventSource = null;
        let terminalReconnectTimer = null;
        let terminalExpanded = false;
        const terminalLevelFilter = new Set(['INFO', 'WARNING', 'ERROR', 'CRITICAL']);

        try {
            terminalExpanded = localStorage.getItem('synapse_terminal_expanded') === '1';
        } catch (e) {}

        /* --- Restore persisted preferences --- */
        function loadPreference(key, fallback) {
            try { return localStorage.getItem('synapse_' + key) || fallback; } catch (e) { return fallback; }
        }
        function savePreference(key, value) {
            try { localStorage.setItem('synapse_' + key, value); } catch (e) {}
        }

        // Restore terminal level filters
        try {
            const savedFilters = localStorage.getItem('synapse_terminal_filters');
            if (savedFilters) {
                const parsed = JSON.parse(savedFilters);
                if (Array.isArray(parsed)) {
                    terminalLevelFilter.clear();
                    parsed.forEach(l => terminalLevelFilter.add(l));
                }
            }
        } catch (e) {}

        // Restore last selected backend
        let savedBackend = loadPreference('selected_backend', '');

        /* --- Theme toggle --- */
        function getTheme() {
            return document.documentElement.dataset.theme || 'dark';
        }

        function setTheme(theme) {
            document.documentElement.dataset.theme = theme;
            try { localStorage.setItem('synapse_theme', theme); } catch (e) {}
            updateThemeToggle();
        }

        function toggleTheme() {
            setTheme(getTheme() === 'dark' ? 'light' : 'dark');
            announce('Theme: ' + getTheme());
        }

        function updateThemeToggle() {
            const icon = document.getElementById('theme-toggle-icon');
            const label = document.getElementById('theme-toggle-label');
            if (!icon || !label) return;
            const isDark = getTheme() === 'dark';
            icon.innerHTML = isDark ? '&#9790;' : '&#9728;';
            label.textContent = isDark ? 'LIGHT' : 'DARK';
        }

        /* --- Router State --- */
        let currentView = '';
        let healthInterval = null;
        let modelsInterval = null;
        const ROUTES = {
            'overview':  { title: 'Overview' },
            'backends':  { title: 'Backends' },
            'models':    { title: 'Models' },
            'terminal':  { title: 'Terminal' },
            'api-docs':  { title: 'API Docs' },
        };
        const DEFAULT_ROUTE = 'overview';
        const isMobile = () => window.matchMedia('(max-width: 700px)').matches;

        /* --- Router --- */
        function parseRoute() {
            const hash = location.hash.replace(/^#\/?/, '').split('?')[0];
            if (ROUTES[hash]) return hash;
            // Restore last view from localStorage if no hash
            const saved = loadPreference('last_view', DEFAULT_ROUTE);
            return ROUTES[saved] ? saved : DEFAULT_ROUTE;
        }

        function navigateTo(viewName) {
            if (!ROUTES[viewName]) viewName = DEFAULT_ROUTE;
            if (viewName === currentView) return;

            const previousView = currentView;
            currentView = viewName;

            const targetHash = '#/' + viewName;
            if (location.hash !== targetHash) {
                history.replaceState(null, '', targetHash);
            }

            document.querySelectorAll('.view').forEach(el => {
                el.classList.toggle('active', el.id === 'view-' + viewName);
            });

            document.querySelectorAll('.sidebar-link').forEach(link => {
                const isActive = link.dataset.view === viewName;
                link.classList.toggle('active', isActive);
                link.setAttribute('aria-current', isActive ? 'page' : 'false');
            });

            teardownView(previousView);
            setupView(viewName);
            closeSidebar();
            savePreference('last_view', viewName);
            announce('Navigated to ' + ROUTES[viewName].title + '.');
        }

        function setupView(viewName) {
            switch (viewName) {
                case 'overview':
                    healthInterval = setInterval(refreshHealth, 30000);
                    refreshHealth();
                    updateOverviewCards();
                    populateOverviewPreview();
                    break;
                case 'backends':
                    healthInterval = setInterval(refreshHealth, 30000);
                    refreshHealth();
                    fetchBackendRoutes().then(() => initializeBackendSelector());
                    break;
                case 'models':
                    modelsInterval = setInterval(refreshModels, 15000);
                    refreshModels();
                    break;
                case 'terminal':
                    connectTerminalFeed();
                    initTerminalControls();
                    break;
                case 'api-docs':
                    initApiDocs();
                    const activeDocTab = document.querySelector('.api-docs-tab.active');
                    if (activeDocTab) switchApiDocTab(activeDocTab);
                    break;
            }
        }

        function teardownView(viewName) {
            switch (viewName) {
                case 'overview':
                    if (healthInterval) { clearInterval(healthInterval); healthInterval = null; }
                    break;
                case 'backends':
                    if (healthInterval) { clearInterval(healthInterval); healthInterval = null; }
                    break;
                case 'models':
                    if (modelsInterval) { clearInterval(modelsInterval); modelsInterval = null; }
                    break;
                case 'terminal':
                    disconnectTerminalFeed();
                    break;
                case 'api-docs':
                    teardownApiDocs();
                    break;
            }
        }

        function disconnectTerminalFeed() {
            if (terminalReconnectTimer) {
                clearTimeout(terminalReconnectTimer);
                terminalReconnectTimer = null;
            }
            if (terminalEventSource) {
                terminalEventSource.close();
                terminalEventSource = null;
            }
            setTerminalConnection('stale', 'disconnected');
        }

        /* --- Sidebar --- */
        function openSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            if (sidebar) sidebar.classList.add('open');
            if (backdrop) backdrop.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            if (sidebar) sidebar.classList.remove('open');
            if (backdrop) backdrop.classList.remove('active');
            document.body.style.overflow = '';
        }

        /* --- Overview Cards --- */
        function syncOverallLed(status) {
            ['overall-dot', 'overall-dot-mobile', 'overview-dot'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.className = 'led status-led ' + status;
            });
        }

        function updateOverviewCards() {
            const statusText = document.getElementById('overview-status-text');
            const backendsVal = document.getElementById('overview-backends-value');
            const backendsSub = document.getElementById('overview-backends-sub');
            const modelsVal = document.getElementById('overview-models-value');
            const modelsSub = document.getElementById('overview-models-sub');
            const errorsVal = document.getElementById('overview-errors-value');
            const errorsSub = document.getElementById('overview-errors-sub');
            const lastcheckVal = document.getElementById('overview-lastcheck-value');
            const lastcheckSub = document.getElementById('overview-lastcheck-sub');

            if (statusText) {
                statusText.textContent = healthState.stale
                    ? 'STALE'
                    : (healthState.status === 'healthy' ? 'ONLINE' : 'DEGRADED');
            }

            if (backendsVal) backendsVal.textContent = String(healthState.total || '--');
            if (backendsSub) {
                backendsSub.textContent = healthState.stale
                    ? 'stale'
                    : healthState.healthy + '/' + healthState.total + ' healthy';
            }

            if (modelsVal) {
                modelsVal.textContent = modelState.stale ? '--' : String(modelState.total);
            }
            if (modelsSub) {
                if (modelState.stale) {
                    modelsSub.textContent = 'stale';
                } else {
                    const parts = [];
                    if (modelState.loaded) parts.push(modelState.loaded + ' loaded');
                    if (modelState.loading) parts.push(modelState.loading + ' loading');
                    if (modelState.failed) parts.push(modelState.failed + ' failed');
                    modelsSub.textContent = parts.length ? parts.join(', ') : modelState.total + ' registered';
                }
            }

            // Errors card: aggregate degraded backends + failed models
            if (errorsVal || errorsSub) {
                const degradedBackends = healthState.stale ? 0 : (healthState.total - healthState.healthy);
                const failedModels = modelState.stale ? 0 : modelState.failed;
                const totalErrors = degradedBackends + failedModels;
                if (errorsVal) {
                    errorsVal.textContent = String(totalErrors);
                    errorsVal.className = 'overview-card-value' + (totalErrors > 0 ? ' err' : '');
                }
                if (errorsSub) {
                    if (totalErrors === 0) {
                        errorsSub.textContent = 'no issues detected';
                    } else {
                        const parts = [];
                        if (degradedBackends) parts.push(degradedBackends + ' degraded node' + (degradedBackends > 1 ? 's' : ''));
                        if (failedModels) parts.push(failedModels + ' failed model' + (failedModels > 1 ? 's' : ''));
                        errorsSub.textContent = parts.join(', ');
                    }
                }
            }

            // Last check card
            if (lastcheckVal || lastcheckSub) {
                const lastMs = Math.max(healthState.lastSuccessMs, modelState.lastSuccessMs);
                if (lastMs > 0) {
                    if (lastcheckVal) lastcheckVal.textContent = new Date(lastMs).toLocaleTimeString();
                    if (lastcheckSub) {
                        const agoSec = Math.floor((Date.now() - lastMs) / 1000);
                        lastcheckSub.textContent = agoSec < 5 ? 'just now' : agoSec + 's ago';
                    }
                } else {
                    if (lastcheckVal) lastcheckVal.textContent = '--';
                    if (lastcheckSub) lastcheckSub.textContent = 'waiting for first poll';
                }
            }
        }

        function populateOverviewPreview() {
            const preview = document.getElementById('overview-terminal-preview');
            const source = document.getElementById('terminal-feed');
            if (!preview || !source) return;
            preview.innerHTML = '';
            const lines = Array.from(source.children).slice(-8);
            lines.forEach(line => {
                preview.appendChild(line.cloneNode(true));
            });
        }

        /* --- Backend Endpoints (fetched from API, no hard-coded routes) --- */
        let BACKEND_ENDPOINTS = {};
        let backendRoutesLoaded = false;

        async function fetchBackendRoutes() {
            if (backendRoutesLoaded) return;
            try {
                const resp = await fetch('/api/backend-routes', { cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                BACKEND_ENDPOINTS = await resp.json();
                backendRoutesLoaded = true;
            } catch (e) {
                // API unavailable — endpoints will show "no route map" gracefully
                console.warn('Failed to fetch backend routes:', e.message);
            }
        }

        const MODEL_CARD_HINTS = [
            {
                pattern: /Nemotron-Nano-3-30B-A3B/i,
                links: [
                    {label: 'NVIDIA BF16 Card', url: 'https://huggingface.co/nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-Base-BF16'},
                    {label: 'GGUF Conversion', url: 'https://huggingface.co/ggml-org/Nemotron-Nano-3-30B-A3B-GGUF'},
                ],
            },
            {
                pattern: /gpt-oss-120b/i,
                links: [{label: 'GGUF Card', url: 'https://huggingface.co/unsloth/gpt-oss-120b-GGUF'}],
            },
            {
                pattern: /MiniMax-M2\\.5/i,
                links: [{label: 'GGUF Card', url: 'https://huggingface.co/unsloth/MiniMax-M2.5-GGUF'}],
            },
            {
                pattern: /Qwen3-8B-Q4_K_M/i,
                links: [{label: 'GGUF Card', url: 'https://huggingface.co/unsloth/Qwen3-8B-GGUF'}],
            },
            {
                pattern: /Qwen2\\.5-Coder-7B-Instruct-Q4_K_M/i,
                links: [{label: 'GGUF Card', url: 'https://huggingface.co/unsloth/Qwen2.5-Coder-7B-Instruct-GGUF'}],
            },
            {
                pattern: /glm-4\\.7-flash-claude-4\\.5-opus/i,
                links: [{label: 'GGUF Card', url: 'https://huggingface.co/TeichAI/GLM-4.7-Flash-Claude-Opus-4.5-High-Reasoning-Distill-GGUF'}],
            },
        ];

        function announce(message) {
            const region = document.getElementById('sr-live-region');
            if (!region) return;
            region.textContent = '';
            setTimeout(() => {
                region.textContent = message;
            }, 10);
        }


        function setTerminalConnection(state, detail = '') {
            const el = document.getElementById('terminal-conn');
            if (!el) return;
            el.className = `terminal-conn ${state}`;
            const suffix = detail ? ` (${detail})` : '';
            el.textContent = `${state}${suffix}`;
        }

        function appendTerminalLine(entry, opts = {}) {
            const host = document.getElementById('terminal-feed');
            if (!host) return;
            const shouldStick = host.scrollTop + host.clientHeight >= host.scrollHeight - 24;
            const line = document.createElement('div');
            const levelValue = String(entry.level || 'INFO').toUpperCase();
            line.className = 'term-line' + (opts.system ? ' system' : '');
            line.dataset.level = levelValue;
            line.setAttribute('aria-label', `${levelValue}: ${String(entry.source || 'gateway')}: ${String(entry.message || '')}`);

            if (!opts.system && !terminalLevelFilter.has(levelValue)) {
                line.style.display = 'none';
            }

            const level = document.createElement('span');
            level.className = 'term-level';
            const levelTone = levelValue.toLowerCase();
            if (levelTone === 'warning' || levelTone === 'error' || levelTone === 'critical') {
                level.classList.add(levelTone);
            }
            level.textContent = levelValue;

            const source = document.createElement('span');
            source.className = 'term-src';
            source.textContent = String(entry.source || 'gateway');

            const msg = document.createElement('span');
            msg.className = 'term-msg';
            msg.textContent = String(entry.message || '');

            line.appendChild(level);
            line.appendChild(source);
            line.appendChild(msg);
            host.appendChild(line);

            while (host.children.length > TERMINAL_MAX_LINES) {
                host.removeChild(host.firstElementChild);
            }
            if (shouldStick) {
                host.scrollTop = host.scrollHeight;
            }
        }

        function toggleTerminalLevel(level) {
            if (terminalLevelFilter.has(level)) {
                terminalLevelFilter.delete(level);
            } else {
                terminalLevelFilter.add(level);
            }
            document.querySelectorAll('.terminal-filter-btn[data-level]').forEach(btn => {
                btn.classList.toggle('active', terminalLevelFilter.has(btn.dataset.level));
            });
            try { localStorage.setItem('synapse_terminal_filters', JSON.stringify([...terminalLevelFilter])); } catch (e) {}
            const host = document.getElementById('terminal-feed');
            if (!host) return;
            host.querySelectorAll('.term-line[data-level]').forEach(line => {
                line.style.display = terminalLevelFilter.has(line.dataset.level) ? '' : 'none';
            });
        }

        function initTerminalControls() {
            document.querySelectorAll('.terminal-filter-btn[data-level]').forEach(btn => {
                btn.addEventListener('click', () => toggleTerminalLevel(btn.dataset.level));
            });
        }

        /* --- API Docs embedded viewer --- */
        let apiDocsInitialized = false;
        let apiDocsActiveTab = null;
        let apiDocsAbortController = null;

        function initApiDocs() {
            if (apiDocsInitialized) return;
            apiDocsInitialized = true;

            document.querySelectorAll('.api-docs-tab').forEach(tab => {
                tab.addEventListener('click', () => switchApiDocTab(tab));
            });

            const iframe = document.getElementById('api-docs-iframe');
            iframe.addEventListener('load', () => {
                if (iframe.src && iframe.src !== 'about:blank') {
                    document.getElementById('api-docs-loader').classList.add('hidden');
                }
            });
        }

        function switchApiDocTab(tab) {
            const src = tab.dataset.docSrc;
            const type = tab.dataset.docType;

            document.querySelectorAll('.api-docs-tab').forEach(t => {
                t.classList.toggle('active', t === tab);
                t.setAttribute('aria-selected', t === tab ? 'true' : 'false');
            });

            const iframe = document.getElementById('api-docs-iframe');
            const jsonPanel = document.getElementById('api-docs-json-panel');
            const jsonPre = document.getElementById('api-docs-json');
            const loader = document.getElementById('api-docs-loader');

            if (apiDocsAbortController) {
                apiDocsAbortController.abort();
                apiDocsAbortController = null;
            }

            if (type === 'iframe') {
                jsonPanel.classList.remove('visible');
                iframe.style.display = '';
                if (apiDocsActiveTab !== src) {
                    loader.classList.remove('hidden');
                    iframe.src = src;
                }
            } else {
                iframe.style.display = 'none';
                jsonPanel.classList.add('visible');
                loader.classList.remove('hidden');
                jsonPre.textContent = '';

                apiDocsAbortController = new AbortController();
                fetch(src, { signal: apiDocsAbortController.signal })
                    .then(res => res.json())
                    .then(data => {
                        jsonPre.textContent = JSON.stringify(data, null, 2);
                        loader.classList.add('hidden');
                    })
                    .catch(err => {
                        if (err.name !== 'AbortError') {
                            jsonPre.textContent = '// ERR: ' + err.message;
                            loader.classList.add('hidden');
                        }
                    });
            }

            apiDocsActiveTab = src;
            announce('API docs: viewing ' + src);
        }

        function teardownApiDocs() {
            const iframe = document.getElementById('api-docs-iframe');
            if (iframe) iframe.src = 'about:blank';
            if (apiDocsAbortController) {
                apiDocsAbortController.abort();
                apiDocsAbortController = null;
            }
            apiDocsActiveTab = null;
        }

        function connectTerminalFeed() {
            if (TERMINAL_FEED_MODE !== 'live') {
                setTerminalConnection('stale', 'mock mode');
                appendTerminalLine(
                    {level: 'INFO', source: 'gateway.bootstrap', message: `terminal feed mode=${TERMINAL_FEED_MODE} instance=${TERMINAL_INSTANCE_ID}`},
                    {system: true},
                );
                return;
            }
            if (terminalEventSource) {
                terminalEventSource.close();
            }
            setTerminalConnection('connecting');
            terminalEventSource = new EventSource('/events/terminal');

            terminalEventSource.addEventListener('log', (event) => {
                try {
                    const payload = JSON.parse(event.data || '{}');
                    appendTerminalLine(payload);
                } catch (e) {
                    appendTerminalLine({level: 'WARNING', source: 'gateway.ui', message: 'failed to parse terminal event'}, {system: true});
                }
            });

            terminalEventSource.addEventListener('meta', (event) => {
                try {
                    const payload = JSON.parse(event.data || '{}');
                    const instance = payload && payload.instance ? String(payload.instance) : TERMINAL_INSTANCE_ID;
                    const bus = payload && payload.bus_mode ? String(payload.bus_mode) : 'local';
                    const detail = `${instance}/${bus}`;
                    setTerminalConnection('live', detail);
                } catch (e) {
                    setTerminalConnection('live', TERMINAL_INSTANCE_ID);
                }
            });

            terminalEventSource.onopen = () => {
                setTerminalConnection('live', TERMINAL_INSTANCE_ID);
            };

            terminalEventSource.onerror = () => {
                setTerminalConnection('stale', 'reconnecting');
                if (terminalEventSource) {
                    terminalEventSource.close();
                    terminalEventSource = null;
                }
                if (terminalReconnectTimer) {
                    clearTimeout(terminalReconnectTimer);
                }
                terminalReconnectTimer = setTimeout(() => {
                    connectTerminalFeed();
                }, TERMINAL_RECONNECT_MS);
            };
        }

        function updateEndpointTotal(total = null) {
            const el = document.getElementById('endpoint-total');
            if (!el) return;
            if (typeof total === 'number') {
                el.textContent = `${total} total`;
                return;
            }
            const count = document.querySelectorAll('#backend-endpoint-groups .endpoint-row').length;
            el.textContent = `${count} total`;
        }

        function formatTimestampFromUnix(seconds) {
            const n = Number(seconds);
            if (!Number.isFinite(n) || n <= 0) return '-';
            const dt = new Date(n * 1000);
            return `${dt.toLocaleString()} (${Math.floor(n)})`;
        }

        function parseRuntimeArgs(args) {
            if (!Array.isArray(args)) return [];
            const rows = [];
            for (let i = 0; i < args.length; i++) {
                const token = args[i];
                if (typeof token !== 'string') {
                    rows.push({key: `arg[${i}]`, value: String(token)});
                    continue;
                }
                if (token.startsWith('--')) {
                    let value = 'true';
                    const next = args[i + 1];
                    if (typeof next === 'string' && !next.startsWith('--')) {
                        value = next;
                        i += 1;
                    }
                    rows.push({key: token, value});
                    continue;
                }
                rows.push({key: `arg[${i}]`, value: token});
            }
            return rows;
        }

        const RUNTIME_ARG_HELP = {
            '--ctx-size': 'Maximum context window in tokens for a single request.',
            '--threads': 'CPU threads for token generation.',
            '--threads-batch': 'CPU threads for prompt/batch processing.',
            '--batch-size': 'Batch token count used during prompt evaluation.',
            '--ubatch-size': 'Micro-batch token count for compute scheduling.',
            '--parallel': 'Number of concurrent slots handled by the model server.',
            '--sleep-idle-seconds': 'Auto-idle timeout before model sleeps.',
            '--model': 'Path to the GGUF file loaded by llama.cpp.',
            '--port': 'Internal llama.cpp child server port.',
            '--host': 'Internal bind host for llama.cpp child server.',
            '--metrics': 'Enables llama.cpp metrics endpoint.',
            '--alias': 'Model alias exposed by router mode.',
        };

        function runtimeArgHelp(key) {
            const norm = String(key || '').toLowerCase();
            return RUNTIME_ARG_HELP[norm] || 'Runtime argument from llama.cpp preset.';
        }

        function renderRuntimeArgs(args) {
            const pairs = parseRuntimeArgs(args);
            if (pairs.length === 0) {
                return '<div class="endpoint-empty">No runtime args exposed.</div>';
            }
            return `<div class="model-arg-grid">${pairs.map((pair) => `
                <div class="model-arg-row">
                    <div class="model-arg-key">${escapeHtml(pair.key)}</div>
                    <div class="model-arg-value">
                        ${escapeHtml(pair.value)}
                        ${pair.key.startsWith('--') ? `<div class="model-arg-help">${escapeHtml(runtimeArgHelp(pair.key))}</div>` : ''}
                    </div>
                </div>`).join('')}</div>`;
        }

        function parseRuntimeArgMap(args) {
            const map = {};
            const pairs = parseRuntimeArgs(args);
            pairs.forEach((pair) => {
                if (typeof pair.key === 'string' && pair.key.startsWith('--')) {
                    map[pair.key] = String(pair.value ?? '');
                }
            });
            return map;
        }

        function inferModelCardLinks(modelId) {
            const id = String(modelId || '');
            for (const hint of MODEL_CARD_HINTS) {
                if (hint.pattern.test(id)) {
                    return hint.links;
                }
            }
            return [{
                label: 'Hugging Face Search',
                url: `https://huggingface.co/models?search=${encodeURIComponent(id)}`,
            }];
        }

        function renderSourceRows(rows) {
            if (!Array.isArray(rows) || rows.length === 0) {
                return '<div class="model-source-meta">No values available.</div>';
            }
            return rows.map((row) => `
                <div class="model-source-row">
                    <div class="model-source-key">${escapeHtml(row.key || '-')}</div>
                    <div class="model-source-value">${escapeHtml(row.value || '-')}</div>
                </div>
            `).join('');
        }

        function renderSourceTruthPanel(modelId, schema, profilePayload) {
            const model = modelRegistry.get(modelId) || {};
            const status = model.status || {};
            const runtimeMap = parseRuntimeArgMap(Array.isArray(status.args) ? status.args : []);
            const profileValues = (profilePayload && typeof profilePayload === 'object' && profilePayload.values && typeof profilePayload.values === 'object')
                ? profilePayload.values
                : {};
            const fields = Array.isArray(schema?.fields) ? schema.fields : [];

            const runtimeRows = [
                {key: 'status', value: String(status.value || 'unknown')},
                {key: '--ctx-size', value: String(runtimeMap['--ctx-size'] || '-')},
                {key: '--batch-size', value: String(runtimeMap['--batch-size'] || '-')},
                {key: '--ubatch-size', value: String(runtimeMap['--ubatch-size'] || '-')},
                {key: '--threads', value: String(runtimeMap['--threads'] || '-')},
                {key: '--threads-batch', value: String(runtimeMap['--threads-batch'] || '-')},
                {key: '--parallel', value: String(runtimeMap['--parallel'] || '-')},
            ];

            const profileRows = Object.entries(profileValues).map(([key, value]) => ({
                key,
                value: value === null || value === undefined ? '(unset)' : String(value),
            }));

            const boundRows = fields
                .filter((field) => field && (field.type === 'number' || field.type === 'integer'))
                .map((field) => ({
                    key: field.name || 'param',
                    value: `${field.min ?? '-'} .. ${field.max ?? '-'} (default ${field.default ?? '-'})`,
                }));

            const links = inferModelCardLinks(modelId).map((link) => (
                `<a class="model-source-link" href="${escapeHtml(link.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(link.label)}</a>`
            )).join(' · ');

            return `
                <div class="model-source-grid">
                    <div class="model-source-card">
                        <div class="model-source-title">Effective Runtime (Live)</div>
                        ${renderSourceRows(runtimeRows)}
                        <div class="model-source-meta">Source: <code>GET /models</code> → <code>status.args</code></div>
                    </div>
                    <div class="model-source-card">
                        <div class="model-source-title">Saved Model Profile</div>
                        ${renderSourceRows(profileRows)}
                        <div class="model-source-meta">Source: <code>GET /models/{id}/profile</code></div>
                    </div>
                    <div class="model-source-card">
                        <div class="model-source-title">Schema Min/Max Bounds</div>
                        ${renderSourceRows(boundRows)}
                        <div class="model-source-meta">Source: <code>GET /models/{id}/schema</code></div>
                    </div>
                    <div class="model-source-card">
                        <div class="model-source-title">Reference Model Cards</div>
                        <div class="model-source-meta">${links}</div>
                        <div class="model-source-meta">Source: Hugging Face model cards (reference only).</div>
                    </div>
                </div>
            `;
        }

        function encodeDomId(value) {
            return String(value).replace(/[^a-zA-Z0-9_-]/g, '_');
        }

        function modelProfileInputId(modelId, fieldName) {
            return `profile_${encodeDomId(modelId)}_${encodeDomId(fieldName)}`;
        }

        function setModelProfileStatus(message, isError = false) {
            const el = document.getElementById('model-profile-status');
            if (!el) return;
            el.className = 'model-profile-status' + (isError ? ' error' : '');
            el.textContent = message;
        }

        async function fetchModelProfileSchema(modelId) {
            const resp = await fetch(`/models/${encodeURIComponent(modelId)}/schema`, {cache: 'no-store'});
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                throw new Error(extractApiErrorMessage(data, resp.status));
            }
            return data;
        }

        async function fetchModelProfileValues(modelId) {
            const resp = await fetch(`/models/${encodeURIComponent(modelId)}/profile`, {cache: 'no-store'});
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                throw new Error(extractApiErrorMessage(data, resp.status));
            }
            return data;
        }

        function renderProfileInput(modelId, field, currentValue) {
            const inputId = modelProfileInputId(modelId, field.name);
            const type = field.type || 'string';
            const value = (currentValue === undefined || currentValue === null) ? '' : String(currentValue);
            const labelText = escapeHtml(field.label || field.name || 'param');
            if (type === 'enum') {
                const choices = Array.isArray(field.choices) ? field.choices : [];
                const options = ['<option value="">(unset)</option>'].concat(
                    choices.map((choice) => {
                        const selected = value === String(choice) ? ' selected' : '';
                        return `<option value="${escapeHtml(choice)}"${selected}>${escapeHtml(choice)}</option>`;
                    }),
                ).join('');
                return `<label class="sr-only" for="${escapeHtml(inputId)}">${labelText}</label><select id="${escapeHtml(inputId)}" class="model-profile-select">${options}</select>`;
            }
            if (type === 'string') {
                return `<label class="sr-only" for="${escapeHtml(inputId)}">${labelText}</label><textarea id="${escapeHtml(inputId)}" class="model-profile-textarea" placeholder="(unset)">${escapeHtml(value)}</textarea>`;
            }
            const htmlType = 'number';
            const minAttr = field.min !== undefined ? ` min="${escapeHtml(String(field.min))}"` : '';
            const maxAttr = field.max !== undefined ? ` max="${escapeHtml(String(field.max))}"` : '';
            const stepAttr = field.step !== undefined ? ` step="${escapeHtml(String(field.step))}"` : '';
            const sliderId = `${inputId}__slider`;
            const valueBadgeId = `${inputId}__value`;
            const sliderValue = value !== ''
                ? value
                : (field.default !== undefined && field.default !== null && field.default !== ''
                    ? String(field.default)
                    : (field.min !== undefined ? String(field.min) : '0'));
            const hasRange = field.min !== undefined && field.max !== undefined;
            if (!hasRange) {
                return `<label class="sr-only" for="${escapeHtml(inputId)}">${labelText}</label><input id="${escapeHtml(inputId)}" class="model-profile-input" type="${htmlType}"${minAttr}${maxAttr}${stepAttr} value="${escapeHtml(value)}" placeholder="(unset)">`;
            }
            return `
                <div class="model-profile-range-wrap">
                    <label class="sr-only" for="${escapeHtml(inputId)}">${labelText}</label>
                    <input id="${escapeHtml(inputId)}" class="model-profile-input" type="${htmlType}"${minAttr}${maxAttr}${stepAttr} value="${escapeHtml(value)}" placeholder="(unset)">
                    <input id="${escapeHtml(sliderId)}" class="model-profile-slider" type="range"${minAttr}${maxAttr}${stepAttr} value="${escapeHtml(sliderValue)}" aria-label="${labelText} slider">
                    <div class="model-profile-range-meta">
                        <span>min ${escapeHtml(String(field.min))}</span>
                        <span id="${escapeHtml(valueBadgeId)}" class="model-profile-range-value">${escapeHtml(value || '(unset)')}</span>
                        <span>max ${escapeHtml(String(field.max))}</span>
                    </div>
                </div>
            `;
        }

        function bindProfileRangeInputs(modelId, schema) {
            const fields = Array.isArray(schema?.fields) ? schema.fields : [];
            fields.forEach((field) => {
                if (!field || (field.type !== 'number' && field.type !== 'integer')) return;
                if (field.min === undefined || field.max === undefined) return;
                const inputId = modelProfileInputId(modelId, field.name);
                const sliderId = `${inputId}__slider`;
                const valueBadgeId = `${inputId}__value`;
                const inputEl = document.getElementById(inputId);
                const sliderEl = document.getElementById(sliderId);
                const valueBadgeEl = document.getElementById(valueBadgeId);
                if (!inputEl || !sliderEl) return;

                const min = Number(field.min);
                const max = Number(field.max);

                const setValueBadge = (raw) => {
                    if (!valueBadgeEl) return;
                    valueBadgeEl.textContent = raw === '' ? '(unset)' : String(raw);
                };

                const clampValue = (raw) => {
                    const n = Number(raw);
                    if (!Number.isFinite(n)) return null;
                    let clamped = Math.max(min, Math.min(max, n));
                    if (field.type === 'integer') {
                        clamped = Math.round(clamped);
                    }
                    return clamped;
                };

                sliderEl.addEventListener('input', () => {
                    const n = clampValue(sliderEl.value);
                    if (n === null) return;
                    inputEl.value = String(n);
                    setValueBadge(String(n));
                });

                const syncFromInput = () => {
                    const raw = (inputEl.value || '').trim();
                    if (raw === '') {
                        setValueBadge('');
                        return;
                    }
                    const n = clampValue(raw);
                    if (n === null) return;
                    inputEl.value = String(n);
                    sliderEl.value = String(n);
                    setValueBadge(String(n));
                };

                inputEl.addEventListener('input', syncFromInput);
                inputEl.addEventListener('change', syncFromInput);

                syncFromInput();
            });
        }

        function renderProfileEditor(modelId, schema, values) {
            const fields = Array.isArray(schema?.fields) ? schema.fields : [];
            const notes = Array.isArray(schema?.notes) ? schema.notes : [];
            const rows = fields.map((field) => {
                const currentValue = values ? values[field.name] : undefined;
                const desc = field.description || '';
                const defaultText = field.default !== undefined && field.default !== ''
                    ? ` Default: ${field.default}.`
                    : '';
                return `
                    <div class="model-profile-row">
                        <div class="model-profile-topline">
                            <div class="model-profile-name">${escapeHtml(field.label || field.name || 'param')}</div>
                            <div class="model-profile-scope">${escapeHtml(field.applies_at || 'generation')}</div>
                        </div>
                        ${renderProfileInput(modelId, field, currentValue)}
                        <div class="model-profile-help">${escapeHtml(desc + defaultText)}</div>
                    </div>
                `;
            }).join('');
            const notesHtml = notes.length > 0
                ? `<div class="model-profile-notes">${notes.map((note) => `<div class="model-profile-note">${escapeHtml(String(note))}</div>`).join('')}</div>`
                : '';
            return `
                <div class="model-profile-grid">${rows}</div>
                <div class="model-profile-actions">
                    <button class="btn focusable" type="button" data-model-profile-save="${escapeHtml(modelId)}">Save Profile</button>
                    <button class="btn load focusable" type="button" data-model-profile-apply="${escapeHtml(modelId)}">Save + Load</button>
                    <button class="btn unload focusable" type="button" data-model-profile-reset="${escapeHtml(modelId)}">Reset Profile</button>
                    <span id="model-profile-status" class="model-profile-status">Profile loaded.</span>
                </div>
                ${notesHtml}
            `;
        }

        function collectModelProfileValues(modelId, schema) {
            const fields = Array.isArray(schema?.fields) ? schema.fields : [];
            const values = {};
            for (const field of fields) {
                const inputId = modelProfileInputId(modelId, field.name);
                const el = document.getElementById(inputId);
                if (!el) continue;
                const raw = (el.value || '').trim();
                if (raw === '') {
                    values[field.name] = null;
                    continue;
                }
                if (field.type === 'number') {
                    const n = Number(raw);
                    if (!Number.isFinite(n)) {
                        throw new Error(`Invalid value for ${field.label || field.name}`);
                    }
                    if (field.min !== undefined && n < Number(field.min)) {
                        throw new Error(`${field.label || field.name} must be >= ${field.min}`);
                    }
                    if (field.max !== undefined && n > Number(field.max)) {
                        throw new Error(`${field.label || field.name} must be <= ${field.max}`);
                    }
                    values[field.name] = n;
                    continue;
                }
                if (field.type === 'integer') {
                    const n = Number(raw);
                    if (!Number.isInteger(n)) {
                        throw new Error(`${field.label || field.name} must be an integer`);
                    }
                    if (field.min !== undefined && n < Number(field.min)) {
                        throw new Error(`${field.label || field.name} must be >= ${field.min}`);
                    }
                    if (field.max !== undefined && n > Number(field.max)) {
                        throw new Error(`${field.label || field.name} must be <= ${field.max}`);
                    }
                    values[field.name] = n;
                    continue;
                }
                if (field.type === 'enum') {
                    values[field.name] = raw.toLowerCase();
                    continue;
                }
                values[field.name] = raw;
            }
            return values;
        }

        async function loadModelProfileEditor(modelId) {
            const host = document.getElementById('model-profile-shell');
            const sourceHost = document.getElementById('model-source-truth-shell');
            if (!host) return;
            host.innerHTML = '<div class="endpoint-empty">Loading profile schema...</div>';
            if (sourceHost) {
                sourceHost.innerHTML = '<div class="endpoint-empty">Loading source-of-truth data...</div>';
            }
            try {
                const [schema, profile] = await Promise.all([
                    fetchModelProfileSchema(modelId),
                    fetchModelProfileValues(modelId),
                ]);
                modelProfileSchemaCache.set(modelId, schema);
                host.innerHTML = renderProfileEditor(modelId, schema, profile.values || {});
                bindProfileRangeInputs(modelId, schema);
                if (sourceHost) {
                    sourceHost.innerHTML = renderSourceTruthPanel(modelId, schema, profile);
                }
                setModelProfileStatus('Profile loaded.');
            } catch (e) {
                host.innerHTML = `<div class="endpoint-empty" style="color:var(--led-red)">Profile load failed: ${escapeHtml(e.message || String(e))}</div>`;
                if (sourceHost) {
                    sourceHost.innerHTML = `<div class="endpoint-empty" style="color:var(--led-red)">Source-of-truth load failed: ${escapeHtml(e.message || String(e))}</div>`;
                }
            }
        }

        async function resetModelProfile(modelId) {
            const resp = await fetch(`/models/${encodeURIComponent(modelId)}/profile`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({values: {}, replace: true}),
            });
            const payload = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                throw new Error(extractApiErrorMessage(payload, resp.status));
            }
            return payload;
        }

        async function saveModelProfile(modelId, loadModel = false) {
            const schema = modelProfileSchemaCache.get(modelId);
            if (!schema) {
                throw new Error('Profile schema not loaded yet');
            }
            const values = collectModelProfileValues(modelId, schema);
            const saveResp = await fetch(`/models/${encodeURIComponent(modelId)}/profile`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({values}),
            });
            const savePayload = await saveResp.json().catch(() => ({}));
            if (!saveResp.ok) {
                throw new Error(extractApiErrorMessage(savePayload, saveResp.status));
            }
            if (loadModel) {
                const applyResp = await fetch(`/models/${encodeURIComponent(modelId)}/profile/apply`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({load_model: true}),
                });
                const applyPayload = await applyResp.json().catch(() => ({}));
                if (!applyResp.ok) {
                    throw new Error(extractApiErrorMessage(applyPayload, applyResp.status));
                }
                if (applyPayload.load && applyPayload.load.success === false) {
                    throw new Error(`Model load failed (status ${applyPayload.load.status_code || 'unknown'})`);
                }
            }
            return savePayload;
        }

        function setModalOpenState(isOpen) {
            const modal = document.getElementById('model-modal');
            if (!modal) return;
            modal.classList.toggle('open', isOpen);
            modal.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
            document.body.style.overflow = isOpen ? 'hidden' : '';
        }

        function updateModelModalLiveInfo(stale = false) {
            const liveEl = document.getElementById('model-modal-live');
            if (!liveEl || !activeModelModalId) return;
            const refreshStamp = modelRegistryRefreshedAt ? new Date(modelRegistryRefreshedAt).toLocaleTimeString() : '-';
            if (stale) {
                liveEl.textContent = `Live registry: refresh failed · showing snapshot from ${refreshStamp}`;
                liveEl.classList.add('stale');
                return;
            }
            liveEl.textContent = `Live registry: updated ${refreshStamp} \u00b7 auto-refresh 15s`;
            liveEl.classList.remove('stale');
        }

        function closeModelModal() {
            activeModelModalId = '';
            setModalOpenState(false);
            const liveEl = document.getElementById('model-modal-live');
            if (liveEl) {
                liveEl.textContent = 'Live registry: waiting for refresh...';
                liveEl.classList.remove('stale');
            }
        }

        function renderModelModal(modelId, shouldAnnounce = false) {
            const model = modelRegistry.get(modelId);
            if (!model) {
                setModelActionStatus(`Model metadata unavailable for ${modelId}`, true);
                return;
            }
            activeModelModalId = modelId;
            const modalTitle = document.getElementById('model-modal-title');
            const subtitle = document.getElementById('model-modal-subtitle');
            const content = document.getElementById('model-modal-content');
            if (!modalTitle || !subtitle || !content) return;

            const status = model && model.status ? model.status : {};
            const statusValue = status && status.value ? status.value : 'unknown';
            const args = Array.isArray(status.args) ? status.args : [];
            const refreshStamp = modelRegistryRefreshedAt ? new Date(modelRegistryRefreshedAt).toLocaleTimeString() : '-';

            modalTitle.textContent = `MODEL :: ${modelId}`;
            subtitle.textContent = `${modelId} :: runtime`;
            content.innerHTML = `
                <div class="model-meta-grid">
                    <div class="model-meta-item">
                        <div class="model-meta-label">Model ID</div>
                        <div class="model-meta-value">${escapeHtml(model.id || '-')}</div>
                    </div>
                    <div class="model-meta-item">
                        <div class="model-meta-label">Object</div>
                        <div class="model-meta-value">${escapeHtml(model.object || '-')}</div>
                    </div>
                    <div class="model-meta-item">
                        <div class="model-meta-label">Owner</div>
                        <div class="model-meta-value">${escapeHtml(model.owned_by || '-')}</div>
                    </div>
                    <div class="model-meta-item">
                        <div class="model-meta-label">Created</div>
                        <div class="model-meta-value">${escapeHtml(formatTimestampFromUnix(model.created))}</div>
                    </div>
                    <div class="model-meta-item">
                        <div class="model-meta-label">Status</div>
                        <div class="model-meta-value">${escapeHtml(statusValue)}</div>
                    </div>
                    <div class="model-meta-item">
                        <div class="model-meta-label">Failed</div>
                        <div class="model-meta-value">${escapeHtml(String(Boolean(status.failed)))}</div>
                    </div>
                    <div class="model-meta-item">
                        <div class="model-meta-label">Args Count</div>
                        <div class="model-meta-value">${escapeHtml(String(args.length))}</div>
                    </div>
                    <div class="model-meta-item">
                        <div class="model-meta-label">Registry Refresh</div>
                        <div class="model-meta-value">${escapeHtml(refreshStamp)}</div>
                    </div>
                    <div class="model-meta-item">
                        <div class="model-meta-label">Source</div>
                        <div class="model-meta-value">GET /models</div>
                    </div>
                </div>
                <div class="panel-title">Runtime Args</div>
                ${renderRuntimeArgs(args)}
                <div class="panel-title">Source Of Truth</div>
                <div id="model-source-truth-shell" class="model-source-shell">
                    <div class="endpoint-empty">Loading source-of-truth data...</div>
                </div>
                <div class="panel-title">Model Profile (Generation + Runtime)</div>
                <div id="model-profile-shell" class="model-profile-shell">
                    <div class="endpoint-empty">Loading profile schema...</div>
                </div>
                <div class="panel-title">Raw Metadata Payload</div>
                <div class="model-json-wrap">
                    <pre class="model-json">${escapeHtml(JSON.stringify(model, null, 2))}</pre>
                </div>
            `;
            setModalOpenState(true);
            updateModelModalLiveInfo(false);
            loadModelProfileEditor(modelId);
            if (shouldAnnounce) {
                announce(`${modelId} metadata opened.`);
            }
        }

        function indexModelRegistry(models) {
            modelRegistry.clear();
            (Array.isArray(models) ? models : []).forEach((item) => {
                if (!item || !item.id) return;
                modelRegistry.set(String(item.id), item);
            });
            modelRegistryRefreshedAt = Date.now();
            if (activeModelModalId && modelRegistry.has(activeModelModalId)) {
                updateModelModalLiveInfo(false);
            }
        }

        function endpointMethodClass(method) {
            const m = String(method || '').toLowerCase();
            if (m === 'get') return 'get';
            if (m === 'post') return 'post';
            if (m === 'delete') return 'delete';
            return 'post';
        }

        function renderBackendEndpoints(backendName) {
            const host = document.getElementById('backend-endpoint-groups');
            const label = document.getElementById('endpoint-selected-backend');
            if (!host || !label) return;

            const spec = BACKEND_ENDPOINTS[backendName];
            if (!spec) {
                label.textContent = `${backendName || 'unknown'} :: no route map`;
                host.innerHTML = `
                    <div class="endpoint-empty">no route map for this node.</div>
                    <div class="endpoint-group">
                        <div class="endpoint-group-title">Ops</div>
                        <div class="endpoint-row">
                            <span class="ep-method get">GET</span>
                            <span class="ep-path">/health</span>
                        </div>
                    </div>`;
                updateEndpointTotal(1);
                return;
            }

            label.textContent = `${spec.title} :: routes`;
            let total = 0;
            host.innerHTML = spec.groups.map((group) => {
                const routes = Array.isArray(group.routes) ? group.routes : [];
                total += routes.length;
                const rows = routes.map((route) => `
                    <div class="endpoint-row">
                        <span class="ep-method ${endpointMethodClass(route.method)}">${escapeHtml(route.method)}</span>
                        <span class="ep-path">${escapeHtml(route.path)}</span>
                    </div>`).join('');
                return `
                    <div class="endpoint-group">
                        <div class="endpoint-group-title">${escapeHtml(group.title)}</div>
                        ${rows}
                    </div>`;
            }).join('');
            updateEndpointTotal(total);
        }

        function selectBackend(backendName, shouldAnnounce = false) {
            if (!backendName) return;
            selectedBackend = backendName;
            savePreference('selected_backend', backendName);
            document.querySelectorAll('.backend-card[data-backend]').forEach((card) => {
                const isActive = card.getAttribute('data-backend') === backendName;
                card.classList.toggle('active', isActive);
                card.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            });
            renderBackendEndpoints(backendName);
            if (shouldAnnounce) {
                announce(`${backendName} endpoints loaded.`);
            }
        }

        function initializeBackendSelector() {
            const cards = Array.from(document.querySelectorAll('.backend-card[data-backend]'));
            if (cards.length === 0) {
                renderBackendEndpoints('');
                return;
            }
            // Restore last selected backend from localStorage, fall back to llama-router or first card
            const saved = savedBackend
                ? cards.find((card) => card.getAttribute('data-backend') === savedBackend)
                : null;
            const preferred = saved || cards.find((card) => card.getAttribute('data-backend') === 'llama-router') || cards[0];
            selectBackend(preferred.getAttribute('data-backend'));
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function statusClass(value, failed) {
            if (failed) return 'failed';
            if (value === 'loaded') return 'loaded';
            if (value === 'loading') return 'loading';
            if (value === 'unloading') return 'unloading';
            if (value === 'unloaded') return 'unloaded';
            return 'unknown';
        }

        function extractApiErrorMessage(payload, httpStatus) {
            if (!payload) return `HTTP ${httpStatus}`;
            if (typeof payload.detail === 'string') return payload.detail;
            if (payload.error && typeof payload.error === 'string') return payload.error;
            if (payload.ERROR && typeof payload.ERROR.message === 'string') return payload.ERROR.message;
            if (payload.ERROR && typeof payload.ERROR.MESSAGE === 'string') return payload.ERROR.MESSAGE;
            const fallback = JSON.stringify(payload);
            return fallback && fallback !== '{}' ? fallback : `HTTP ${httpStatus}`;
        }

        function getRegistryModels() {
            return Array.from(modelRegistry.values());
        }


        function setModelActionStatus(message, isError = false) {
            const el = document.getElementById('model-action-status');
            if (!el) return;
            el.className = 'model-action-status' + (isError ? ' error' : '');
            el.textContent = message;
        }

        function setModelButtonsDisabled(disabled) {
            const buttons = document.querySelectorAll('button[data-model-action]');
            buttons.forEach((button) => {
                button.disabled = Boolean(disabled);
            });
        }

        function applyHealthStaleState(message) {
            syncOverallLed('stale');

            const cards = document.querySelectorAll('[data-backend]');
            cards.forEach((card) => {
                const sd = card.querySelector('.led');
                const st = card.querySelector('.backend-status');
                if (sd) sd.className = 'led stale';
                if (st) {
                    const base = st.dataset.lastKnownStatus || st.textContent || 'Unknown';
                    st.textContent = `${base} [stale]`;
                }
            });

            const info = document.getElementById('refresh-info');
            if (info) info.innerHTML = `Unable to reach health endpoint. Showing last known state. <button class="retry-btn" onclick="refreshHealth()">Retry now</button>`;

            healthState.stale = true;
        }


        function renderModelsTable(models) {
            const body = document.getElementById('models-table-body');
            if (!body) return;
            if (!Array.isArray(models) || models.length === 0) {
                body.innerHTML = '<tr><td colspan="3" style="color:var(--text-tertiary)">no models registered.</td></tr>';
                return;
            }
            body.innerHTML = models.map((m) => {
                const id = m && m.id ? String(m.id) : 'unknown';
                const status = m && m.status ? m.status : {};
                const statusValue = status.value || 'unknown';
                const failed = Boolean(status.failed);
                const pendingAction = modelPendingActions.get(id) || '';
                let effectiveStatus = statusValue;
                let effectiveFailed = failed;
                if (pendingAction === 'load') {
                    effectiveStatus = 'loading';
                    effectiveFailed = false;
                } else if (pendingAction === 'unload') {
                    effectiveStatus = 'unloading';
                    effectiveFailed = false;
                }
                const canLoad = !modelActionInFlight && !pendingAction && effectiveStatus !== 'loaded' && effectiveStatus !== 'loading';
                const canUnload = !modelActionInFlight && !pendingAction && effectiveStatus === 'loaded';
                return `<tr>
                    <td><button class="model-link focusable" data-model-info="${escapeHtml(id)}" type="button">${escapeHtml(id)}</button></td>
                    <td><span class="status-pill ${statusClass(effectiveStatus, effectiveFailed)}">${escapeHtml(effectiveFailed ? 'failed' : effectiveStatus)}</span></td>
                    <td>
                        <div class="model-actions">
                            <button class="btn load" data-model-action="load" data-model-id="${escapeHtml(id)}" ${canLoad ? '' : 'disabled'}>[ load ]</button>
                            <button class="btn unload" data-model-action="unload" data-model-id="${escapeHtml(id)}" ${canUnload ? '' : 'disabled'}>[ unload ]</button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        /* --- Model search/filter --- */
        let modelSearchQuery = '';
        function filterModelsTable() {
            const body = document.getElementById('models-table-body');
            if (!body) return;
            const q = modelSearchQuery.toLowerCase();
            body.querySelectorAll('tr').forEach(row => {
                if (!q) { row.style.display = ''; return; }
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(q) ? '' : 'none';
            });
        }

        function wait(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
        }

        async function waitForModelStatus(modelId, targetStatus, actionLabel, timeoutMs = 90000, intervalMs = 1500) {
            const deadline = Date.now() + timeoutMs;
            while (Date.now() < deadline) {
                await refreshModels(true);
                const model = modelRegistry.get(modelId);
                const status = model && model.status && model.status.value ? model.status.value : 'unknown';
                const failed = Boolean(model && model.status && model.status.failed);
                if (failed) {
                    throw new Error(`validation failed (${status})`);
                }
                if (status === targetStatus) {
                    return true;
                }
                setModelActionStatus(`${actionLabel} ${modelId}... validating (${status})`);
                await wait(intervalMs);
            }
            return false;
        }

        async function refreshModels(force = false) {
            const info = document.getElementById('models-refresh-info');
            if (modelActionInFlight && !force) return;
            const requestToken = ++modelsRequestToken;
            if (modelsAbortController) {
                modelsAbortController.abort();
            }
            modelsAbortController = new AbortController();

            try {
                const resp = await fetch('/models', {
                    signal: modelsAbortController.signal,
                    cache: 'no-store',
                });
                const data = await resp.json();
                if (!resp.ok) {
                    const detail = data && data.detail ? data.detail : `HTTP ${resp.status}`;
                    throw new Error(detail);
                }

                if (requestToken < latestModelsToken) return;
                latestModelsToken = requestToken;

                const models = Array.isArray(data.data) ? data.data : [];
                indexModelRegistry(models);
                renderModelsTable(models);
                filterModelsTable();
                const now = new Date();
                if (info) {
                    info.textContent = 'Last checked: ' + now.toLocaleTimeString() + ' \u00b7 refreshes every 15s';
                }

                let loaded = 0;
                let loading = 0;
                let failed = 0;
                models.forEach((item) => {
                    const status = item && item.status ? item.status : {};
                    if (status.failed) {
                        failed += 1;
                    } else if (status.value === 'loaded') {
                        loaded += 1;
                    } else if (status.value === 'loading') {
                        loading += 1;
                    }
                });

                modelState.loaded = loaded;
                modelState.loading = loading;
                modelState.failed = failed;
                modelState.total = models.length;
                modelState.stale = false;
                modelState.lastSuccessMs = Date.now();
                models.forEach((item) => {
                    const id = item && item.id ? String(item.id) : '';
                    if (!id) return;
                    const pending = modelPendingActions.get(id);
                    if (!pending) return;
                    const value = item && item.status && item.status.value ? item.status.value : '';
                    if ((pending === 'load' && value === 'loaded') || (pending === 'unload' && value === 'unloaded')) {
                        modelPendingActions.delete(id);
                    }
                    if (item && item.status && item.status.failed) {
                        modelPendingActions.delete(id);
                    }
                });
                modelsStaleAnnounced = false;
                if (currentView === 'overview') updateOverviewCards();

            } catch (e) {
                if (e && e.name === 'AbortError') return;
                if (requestToken < latestModelsToken) return;
                latestModelsToken = requestToken;

                if (info) {
                    info.textContent = 'Model refresh failed \u00b7 retrying in 15s';
                }
                setModelActionStatus('Unable to reach model registry. Backend may be restarting.', true);
                const body = document.getElementById('models-table-body');
                if (body) {
                    body.innerHTML = '<tr><td colspan="3" style="color:var(--led-red)">Unable to reach model registry. <button class="retry-btn" onclick="refreshModels()">Retry now</button></td></tr>';
                }


                modelState.stale = true;

                updateModelModalLiveInfo(true);
                if (!modelsStaleAnnounced) {
                    announce('Model telemetry is stale.');
                    modelsStaleAnnounced = true;
                }
            }
        }

        async function runModelAction(action, modelId) {
            if (modelActionInFlight) {
                setModelActionStatus('Another model action is still running...');
                return;
            }
            const actionUpper = action.toUpperCase();
            const targetStatus = action === 'unload' ? 'unloaded' : 'loaded';
            const requestBody = {model: modelId};
            modelActionInFlight = true;
            setModelButtonsDisabled(true);
            modelPendingActions.set(modelId, action);
            renderModelsTable(getRegistryModels());
            setModelActionStatus(`${actionUpper} ${modelId}... in progress`);
            try {
                const resp = await fetch(`/models/${action}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody),
                });
                const payload = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    const detail = extractApiErrorMessage(payload, resp.status);
                    const detailLc = String(detail).toLowerCase();
                    if (action === 'unload' && detailLc.includes('model is not loaded')) {
                        modelPendingActions.delete(modelId);
                        setModelActionStatus(`${actionUpper} ${modelId}: already unloaded`);
                        announce(`${modelId} was already unloaded.`);
                        await refreshModels(true);
                        return;
                    }
                    if (action === 'load' && detailLc.includes('already loaded')) {
                        modelPendingActions.delete(modelId);
                        setModelActionStatus(`${actionUpper} ${modelId}: already loaded`);
                        announce(`${modelId} was already loaded.`);
                        await refreshModels(true);
                        return;
                    }
                    throw new Error(detail || `HTTP ${resp.status}`);
                }
                setModelActionStatus(`${actionUpper} ${modelId}: request accepted, validating...`);
                const ok = await waitForModelStatus(modelId, targetStatus, actionUpper);
                if (!ok) {
                    throw new Error(`timed out waiting for ${targetStatus}`);
                }
                setModelActionStatus(`${actionUpper} ${modelId}: ${targetStatus}`);
                announce(`${actionUpper} ${modelId} confirmed ${targetStatus}.`);
            } catch (e) {
                setModelActionStatus(`${actionUpper} ${modelId}: ${e.message}`, true);
                announce(`${actionUpper} ${modelId} failed.`);
                modelPendingActions.delete(modelId);
            } finally {
                await refreshModels(true);
                modelActionInFlight = false;
                modelPendingActions.delete(modelId);
                renderModelsTable(getRegistryModels());
                setModelButtonsDisabled(false);

            }
        }

        function updateUptime() {
            uptimeSeconds++;
            const d = Math.floor(uptimeSeconds / 86400);
            const h = Math.floor((uptimeSeconds % 86400) / 3600);
            const m = Math.floor((uptimeSeconds % 3600) / 60);
            const s = uptimeSeconds % 60;
            const parts = [];
            if (d) parts.push(d + 'd');
            if (h) parts.push(h + 'h');
            if (m) parts.push(m + 'm');
            parts.push(s + 's');
            const text = parts.join(' ');
            const el = document.getElementById('uptime');
            if (el) el.textContent = text;
            const ov = document.getElementById('overview-uptime');
            if (ov) ov.textContent = text;
        }

        async function refreshHealth() {
            const requestToken = ++healthRequestToken;
            if (healthAbortController) {
                healthAbortController.abort();
            }
            healthAbortController = new AbortController();

            try {
                const resp = await fetch('/health', {
                    signal: healthAbortController.signal,
                    cache: 'no-store',
                });
                const data = await resp.json();

                if (requestToken < latestHealthToken) return;
                latestHealthToken = requestToken;

                syncOverallLed(data.status === 'healthy' ? 'healthy' : 'degraded');
                const backends = data.backends || {};
                const backendEntries = Object.entries(backends);
                let healthyCount = 0;

                if (data.status !== 'healthy' && !healthStaleAnnounced) {
                    announce('Gateway health degraded.');
                    healthStaleAnnounced = true;
                }

                for (const [name, info] of Object.entries(backends)) {
                    const card = document.querySelector('[data-backend="' + name + '"]');
                    if (!card) continue;
                    const sd = card.querySelector('.led');
                    const st = card.querySelector('.backend-status');
                    const status = info.status || 'unreachable';
                    if (status === 'healthy') healthyCount += 1;
                    sd.className = 'led ' + status;
                    let label = status.charAt(0).toUpperCase() + status.slice(1);
                    if (info.code) label += ' (' + info.code + ')';
                    if (info.error) label += ' \u2014 ' + info.error.substring(0, 60);
                    st.textContent = label;
                    st.dataset.lastKnownStatus = label;
                }
                const now = new Date();
                document.getElementById('refresh-info').textContent =
                    'Last checked: ' + now.toLocaleTimeString() + ' \u00b7 refreshes every 30s';

                healthState.status = data.status === 'healthy' ? 'healthy' : 'degraded';
                healthState.healthy = healthyCount;
                healthState.total = backendEntries.length;
                healthState.stale = false;
                healthState.lastSuccessMs = Date.now();
                if (data.status === 'healthy') {
                    healthStaleAnnounced = false;
                }
                if (currentView === 'overview') updateOverviewCards();

            } catch (e) {
                if (e && e.name === 'AbortError') return;
                if (requestToken < latestHealthToken) return;
                latestHealthToken = requestToken;
                applyHealthStaleState('Health refresh failed');
                if (!healthStaleAnnounced) {
                    announce('Health telemetry is stale.');
                    healthStaleAnnounced = true;
                }
            }
        }

        document.addEventListener('click', (event) => {
            const modalCloseBtn = event.target.closest('#model-modal-close');
            if (modalCloseBtn) {
                closeModelModal();
                return;
            }

            const modalBackdrop = event.target.closest('#model-modal');
            if (modalBackdrop && event.target === modalBackdrop) {
                closeModelModal();
                return;
            }

            const profileSaveBtn = event.target.closest('button[data-model-profile-save]');
            if (profileSaveBtn) {
                const modelId = profileSaveBtn.getAttribute('data-model-profile-save');
                if (!modelId) return;
                setModelProfileStatus('Saving profile...');
                saveModelProfile(modelId, false)
                    .then(async () => {
                        setModelProfileStatus('Profile saved.');
                        await refreshModels(true);
                        await loadModelProfileEditor(modelId);
                        announce(`Profile saved for ${modelId}.`);
                    })
                    .catch((e) => {
                        setModelProfileStatus(`Save failed: ${e.message}`, true);
                    });
                return;
            }

            const profileApplyBtn = event.target.closest('button[data-model-profile-apply]');
            if (profileApplyBtn) {
                const modelId = profileApplyBtn.getAttribute('data-model-profile-apply');
                if (!modelId) return;
                setModelProfileStatus('Saving and loading model...');
                saveModelProfile(modelId, true)
                    .then(async () => {
                        setModelProfileStatus('Profile applied and model load requested.');
                        await refreshModels(true);
                        await loadModelProfileEditor(modelId);
                        announce(`Profile applied for ${modelId}.`);
                    })
                    .catch((e) => {
                        setModelProfileStatus(`Apply failed: ${e.message}`, true);
                    });
                return;
            }

            const profileResetBtn = event.target.closest('button[data-model-profile-reset]');
            if (profileResetBtn) {
                const modelId = profileResetBtn.getAttribute('data-model-profile-reset');
                if (!modelId) return;
                setModelProfileStatus('Resetting profile...');
                resetModelProfile(modelId)
                    .then(async () => {
                        setModelProfileStatus('Profile reset.');
                        await refreshModels(true);
                        await loadModelProfileEditor(modelId);
                        announce(`Profile reset for ${modelId}.`);
                    })
                    .catch((e) => {
                        setModelProfileStatus(`Reset failed: ${e.message}`, true);
                    });
                return;
            }

            const backendCard = event.target.closest('.backend-card[data-backend]');
            if (backendCard) {
                const backendName = backendCard.getAttribute('data-backend');
                if (backendName) {
                    selectBackend(backendName, true);
                }
                return;
            }

            const modelInfoBtn = event.target.closest('button[data-model-info]');
            if (modelInfoBtn) {
                const modelId = modelInfoBtn.getAttribute('data-model-info');
                if (modelId) {
                    renderModelModal(modelId, true);
                }
                return;
            }

            const btn = event.target.closest('button[data-model-action]');
            if (!btn) return;
            const action = btn.getAttribute('data-model-action');
            const modelId = btn.getAttribute('data-model-id');
            if (!action || !modelId) return;
            runModelAction(action, modelId);
        });

        /* --- Keyboard --- */
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const modal = document.getElementById('model-modal');
                if (modal && modal.classList.contains('open')) {
                    closeModelModal();
                    return;
                }
                closeSidebar();
                return;
            }
            const backendCard = event.target.closest('.backend-card[data-backend]');
            if (!backendCard) return;
            if (event.key !== 'Enter' && event.key !== ' ') return;
            event.preventDefault();
            const backendName = backendCard.getAttribute('data-backend');
            if (backendName) {
                selectBackend(backendName, true);
            }
        });

        /* --- Sidebar navigation --- */
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const view = link.dataset.view;
                if (view) {
                    location.hash = '#/' + view;
                }
            });
        });

        /* --- Mobile hamburger --- */
        document.getElementById('hamburger-btn')?.addEventListener('click', openSidebar);
        document.getElementById('sidebar-backdrop')?.addEventListener('click', closeSidebar);
        document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
        updateThemeToggle();

        /* --- Refresh models button --- */
        document.getElementById('refresh-models-btn')?.addEventListener('click', () => {
            refreshModels();
        });

        /* --- Model search input --- */
        document.getElementById('model-search')?.addEventListener('input', (e) => {
            modelSearchQuery = (e.target.value || '').trim();
            filterModelsTable();
        });

        /* --- Keyboard Shortcuts --- */
        const VIEW_KEYS = { '1': 'overview', '2': 'backends', '3': 'models', '4': 'terminal', '5': 'api-docs' };
        let kbdHintTimer = null;

        function showKbdHint() {
            const el = document.getElementById('kbd-hint');
            if (!el || isMobile()) return;
            el.classList.add('visible');
            if (kbdHintTimer) clearTimeout(kbdHintTimer);
            kbdHintTimer = setTimeout(() => { el.classList.remove('visible'); }, 3000);
        }

        document.addEventListener('keydown', (event) => {
            // Skip shortcuts when focus is in an input/textarea/select
            const tag = event.target.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

            // ? — show shortcut hint
            if (event.key === '?' && !event.ctrlKey && !event.metaKey) {
                event.preventDefault();
                showKbdHint();
                return;
            }

            // 1-5 — navigate views
            if (VIEW_KEYS[event.key] && !event.ctrlKey && !event.metaKey && !event.altKey) {
                event.preventDefault();
                location.hash = '#/' + VIEW_KEYS[event.key];
                return;
            }

            // r — refresh current view data
            if (event.key === 'r' && !event.ctrlKey && !event.metaKey) {
                event.preventDefault();
                if (currentView === 'overview' || currentView === 'backends') refreshHealth();
                if (currentView === 'models' || currentView === 'overview') refreshModels();
                announce('Refreshed.');
                return;
            }

            // t — toggle theme
            if (event.key === 't' && !event.ctrlKey && !event.metaKey) {
                event.preventDefault();
                toggleTheme();
                return;
            }

            // / — focus model search (if on models view)
            if (event.key === '/' && !event.ctrlKey && !event.metaKey) {
                if (currentView === 'models') {
                    event.preventDefault();
                    const searchInput = document.getElementById('model-search');
                    if (searchInput) searchInput.focus();
                }
                return;
            }
        });

        /* --- Always-running uptime (lightweight) --- */
        setInterval(updateUptime, 1000);

        /* --- Boot router --- */
        navigateTo(parseRoute());
        window.addEventListener('hashchange', () => {
            navigateTo(parseRoute());
        });

        /* --- Resize handler --- */
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (window.innerWidth > 700) closeSidebar();
            }, 250);
        });
    </script>
</body>
</html>